<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="In this example, the main focus is the classification of individual states of a motor.">

<title>mlmvn - Sensorless Drive Diagnosis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="mlmvn - Sensorless Drive Diagnosis">
<meta property="og:description" content="In this example, the main focus is the classification of individual states of a motor.">
<meta property="og:site-name" content="mlmvn">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">mlmvn</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Sensorless Drive Diagnosis</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">MLMVN</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../layers.html" class="sidebar-item-text sidebar-link">Layers</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../loss.html" class="sidebar-item-text sidebar-link">Loss</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../optim.html" class="sidebar-item-text sidebar-link">Optimizer</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Examples</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../examples/xor/xor.html" class="sidebar-item-text sidebar-link">XOR</a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">Moons</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../examples/moons/moons.html" class="sidebar-item-text sidebar-link">Building a Binary Classifier</a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">SDD</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  examples/autass/00_autass.ipynb
  </li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#load-data" id="toc-load-data" class="nav-link active" data-scroll-target="#load-data">Load Data</a></li>
  <li><a href="#config" id="toc-config" class="nav-link" data-scroll-target="#config">Config</a></li>
  <li><a href="#single-layer" id="toc-single-layer" class="nav-link" data-scroll-target="#single-layer">Single Layer</a>
  <ul>
  <li><a href="#mlmvn-48-10-11" id="toc-mlmvn-48-10-11" class="nav-link" data-scroll-target="#mlmvn-48-10-11">MLMVN [48-10-11]</a></li>
  <li><a href="#mlmvn-48-20-11" id="toc-mlmvn-48-20-11" class="nav-link" data-scroll-target="#mlmvn-48-20-11">MLMVN [48-20-11]</a></li>
  <li><a href="#mlmvn-48-50-11" id="toc-mlmvn-48-50-11" class="nav-link" data-scroll-target="#mlmvn-48-50-11">MLMVN [48-50-11]</a></li>
  <li><a href="#mlmvn-48-100-11" id="toc-mlmvn-48-100-11" class="nav-link" data-scroll-target="#mlmvn-48-100-11">MLMVN [48-100-11]</a></li>
  </ul></li>
  <li><a href="#multi-layer" id="toc-multi-layer" class="nav-link" data-scroll-target="#multi-layer">Multi Layer</a>
  <ul>
  <li><a href="#mlmvn-48-10-10-11" id="toc-mlmvn-48-10-10-11" class="nav-link" data-scroll-target="#mlmvn-48-10-10-11">MLMVN [48-10-10-11]</a></li>
  <li><a href="#mlmvn-48-20-20-11" id="toc-mlmvn-48-20-20-11" class="nav-link" data-scroll-target="#mlmvn-48-20-20-11">MLMVN [48-20-20-11]</a></li>
  <li><a href="#mlmvn-48-50-50-11" id="toc-mlmvn-48-50-50-11" class="nav-link" data-scroll-target="#mlmvn-48-50-50-11">MLMVN [48-50-50-11]</a></li>
  <li><a href="#mlmvn-48-100-100-11" id="toc-mlmvn-48-100-100-11" class="nav-link" data-scroll-target="#mlmvn-48-100-100-11">MLMVN [48-100-100-11]</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/antonpf/mlmvn/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Sensorless Drive Diagnosis</h1>
</div>

<div>
  <div class="description">
    In this example, the main focus is the classification of individual states of a motor.
  </div>
</div>


<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="load-data" class="level2">
<h2 class="anchored" data-anchor-id="load-data">Load Data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>train_csv <span class="op">=</span> pd.read_csv(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data/autass_data2.csv"</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    header<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    dtype<span class="op">=</span>np.double,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> np.array(train_csv.values[:, <span class="dv">1</span>:<span class="dv">50</span>])</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> train_csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> data[:, <span class="dv">0</span>:<span class="dv">48</span>]</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> data[:, <span class="dv">48</span>].astype(<span class="bu">int</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> copy.copy(y)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>yt[yt <span class="op">==</span> <span class="dv">0</span>] <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>yt[yt <span class="op">==</span> <span class="dv">1</span>] <span class="op">=</span> <span class="dv">21</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>yt[yt <span class="op">==</span> <span class="dv">2</span>] <span class="op">=</span> <span class="dv">22</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>yt[yt <span class="op">==</span> <span class="dv">3</span>] <span class="op">=</span> <span class="dv">23</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>yt[yt <span class="op">==</span> <span class="dv">4</span>] <span class="op">=</span> <span class="dv">26</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>yt[yt <span class="op">==</span> <span class="dv">5</span>] <span class="op">=</span> <span class="dv">24</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>yt[yt <span class="op">==</span> <span class="dv">6</span>] <span class="op">=</span> <span class="dv">27</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>yt[yt <span class="op">==</span> <span class="dv">7</span>] <span class="op">=</span> <span class="dv">29</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>yt[yt <span class="op">==</span> <span class="dv">8</span>] <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>yt[yt <span class="op">==</span> <span class="dv">9</span>] <span class="op">=</span> <span class="dv">25</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>yt[yt <span class="op">==</span> <span class="dv">10</span>] <span class="op">=</span> <span class="dv">28</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>yt <span class="op">-=</span> <span class="dv">20</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> yt</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> yt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="config" class="level2">
<h2 class="anchored" data-anchor-id="config">Config</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">538</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="single-layer" class="level2">
<h2 class="anchored" data-anchor-id="single-layer">Single Layer</h2>
<section id="mlmvn-48-10-11" class="level3">
<h3 class="anchored" data-anchor-id="mlmvn-48-10-11">MLMVN [48-10-11]</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>PATH <span class="op">=</span> <span class="bu">str</span>(Path.cwd() <span class="op">/</span> <span class="st">"models/autass-mlmvn_48-10-11.pt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model(nn.Module):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, categories, periodicity):</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.categories <span class="op">=</span> categories</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.periodicity <span class="op">=</span> periodicity</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.first_linear <span class="op">=</span> FirstLayer(<span class="dv">48</span>, <span class="dv">10</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act1 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear_out <span class="op">=</span> OutputLayer(<span class="dv">10</span>, <span class="dv">11</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act2 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Hooks</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.first_layer_hook_handle <span class="op">=</span> <span class="va">self</span>.first_linear.register_full_backward_hook(</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.first_layer_backward_hook</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_hook_handle <span class="op">=</span> <span class="va">self</span>.linear_out.register_full_backward_hook(</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.output_layer_backward_hook</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.first_linear(x)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act1(x)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.linear_out(x)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act2(x)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> first_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"first_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> hidden_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"hidden_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> output_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"output_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> angle2class(<span class="va">self</span>, x: torch.tensor) <span class="op">-&gt;</span> torch.tensor:</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        tmp <span class="op">=</span> x.angle() <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> np.pi</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        angle <span class="op">=</span> torch.remainder(tmp, <span class="dv">2</span> <span class="op">*</span> np.pi)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This will be the discrete output (the number of sector)</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        o <span class="op">=</span> torch.floor(<span class="va">self</span>.categories <span class="op">*</span> <span class="va">self</span>.periodicity <span class="op">*</span> angle <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> np.pi))</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.remainder(o, <span class="va">self</span>.categories)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, x):</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a><span class="co">        Performs the prediction task of the network</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a><span class="co">          x: torch.Tensor</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a><span class="co">            Input tensor of size ([3])</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a><span class="co">          Most likely class i.e., Label with the highest score</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pass the data through the networks</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.forward(x)</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Choose the label with the highest score</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># return torch.argmax(output, 1)</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.angle2class(output)</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit(model, X, y, epochs, batch_size, optimizer, criterion, categories, periodicity):</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List of losses for visualization</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>    losses <span class="op">=</span> []</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> []</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>    acc_best <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pass the data through the network and compute the loss</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We'll use the whole dataset during the training instead of using batches</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># in to order to keep the code simple for now.</span></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>        batch_loss <span class="op">=</span> []</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>((X.shape[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span>) <span class="op">//</span> batch_size <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>            start_j <span class="op">=</span> j <span class="op">*</span> batch_size</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>            end_j <span class="op">=</span> start_j <span class="op">+</span> batch_size</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>            xb <span class="op">=</span> X[start_j:end_j]</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>            yb <span class="op">=</span> y[start_j:end_j]</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> model(xb)</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(y_pred, yb, categories, periodicity)</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>            batch_loss.append((torch.<span class="bu">abs</span>(loss)).detach().numpy())</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>            optimizer.step(inputs<span class="op">=</span>xb, layers<span class="op">=</span><span class="bu">list</span>(model.children()))</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>        losses.append(<span class="bu">sum</span>(batch_loss) <span class="op">/</span> <span class="bu">len</span>(batch_loss))</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">9</span>:</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Epoch </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> loss is </span><span class="sc">{</span>losses[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> model.predict(X)</span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>        scores.append(accuracy(y_pred.squeeze(), y))</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>        Logger.current_logger().report_scalar(</span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Loss/Acc"</span>, <span class="st">"Loss"</span>, iteration<span class="op">=</span>i, value<span class="op">=</span>losses[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>        writer.add_scalar(<span class="st">"Loss"</span>, losses[<span class="op">-</span><span class="dv">1</span>], i)</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>        Logger.current_logger().report_scalar(</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Loss/Acc"</span>, <span class="st">"Acc"</span>, iteration<span class="op">=</span>i, value<span class="op">=</span>scores[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>        writer.add_scalar(<span class="st">"Accuracy"</span>, scores[<span class="op">-</span><span class="dv">1</span>], i)</span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key <span class="kw">in</span> model_dict:</span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> key_layer <span class="kw">in</span> model_dict[key]:</span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> key_layer <span class="kw">in</span> [<span class="st">"weights"</span>, <span class="st">"bias"</span>]:</span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>                    log_label <span class="op">=</span> <span class="bu">str</span>(key) <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> <span class="bu">str</span>(key_layer)</span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>                    log_label.replace(<span class="st">" "</span>, <span class="st">""</span>)</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_real"</span>, model_dict[key][key_layer].real, i</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_imag"</span>, model_dict[key][key_layer].imag, i</span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_mag"</span>, torch.<span class="bu">abs</span>(model_dict[key][key_layer]), i</span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_angle"</span>, torch.angle(model_dict[key][key_layer]), i</span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> scores[<span class="op">-</span><span class="dv">1</span>] <span class="op">&gt;</span> acc_best:</span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>            acc_best <span class="op">=</span> scores[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>            torch.save(model.state_dict(), PATH)</span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>    writer.close()</span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> losses, scores</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(categories<span class="op">=</span>categories, periodicity<span class="op">=</span>periodicity)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> ComplexMSELoss.<span class="bu">apply</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> ECL(model.parameters(), lr<span class="op">=</span>lr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>task <span class="op">=</span> Task.init(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    project_name<span class="op">=</span><span class="st">"mlmvn"</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    task_name<span class="op">=</span><span class="st">"SDD-mlmvn-[48-10-11]"</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    tags<span class="op">=</span>[<span class="st">"mlmvn"</span>, <span class="st">"SDD"</span>, <span class="st">"single_run"</span>],</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>writer <span class="op">=</span> SummaryWriter()</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">#  capture a dictionary of hyperparameters with config</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>config_dict <span class="op">=</span> {</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"learning_rate"</span>: <span class="dv">1</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"epochs"</span>: epochs,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"batch_size"</span>: batch_size,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"optim"</span>: <span class="st">"ECL"</span>,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"categories"</span>: categories,</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"periodicity"</span>: periodicity,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"layer"</span>: <span class="st">"[48-10-11]"</span>,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>task.<span class="ex">connect</span>(config_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ClearML Task: created new task id=2771750f687848d0b040bf19c0328338
ClearML results page: http://194.94.231.172:8080/projects/cdefd6ee85454e49be01962ad715eca0/experiments/2771750f687848d0b040bf19c0328338/output/log</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'learning_rate': 1,
 'epochs': 200,
 'batch_size': 538,
 'optim': 'ECL',
 'categories': 2,
 'periodicity': 1,
 'layer': '[48-10-11]'}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>x_train, x_valid, y_train, y_valid <span class="op">=</span> get_splitted_data(X, y, neuronCats)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>losses, scores <span class="op">=</span> fit(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    x_train,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    y_train,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    epochs<span class="op">=</span>epochs,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>batch_size,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    optimizer<span class="op">=</span>optimizer,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    criterion<span class="op">=</span>criterion,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    categories<span class="op">=</span>categories,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    periodicity<span class="op">=</span>periodicity,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>model.load_state_dict(torch.load(PATH))</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(x_train)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> accuracy(y_pred.squeeze(), y_train)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train Acc.: "</span>, acc)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>Logger.current_logger().report_single_value(</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Train Acc."</span>,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    value<span class="op">=</span>acc,</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(x_valid)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> accuracy(y_pred.squeeze(), y_valid)</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Val Acc.: "</span>, acc)</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>Logger.current_logger().report_single_value(</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Val Acc."</span>,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    value<span class="op">=</span>acc,</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_valid, y_pred.detach().numpy(), zero_division<span class="op">=</span><span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_9096/3249266730.py:46: UserWarning:

To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>2022-09-20 08:29:25,993 - clearml.frameworks - INFO - Found existing registered model id=caa96da5a415490ca1ea0f95b383f403 [/home/antonpfeifer/Documents/mlmvn/nbs/examples/autass/models/autass-mlmvn_48-10-11.pt] reusing it.
Epoch 9 loss is 0.2837285218377664
Epoch 19 loss is 0.431940673221039
Epoch 29 loss is 0.3961146214247004
Epoch 39 loss is 0.39737014772407764
Epoch 49 loss is 0.38761378372742683
Epoch 59 loss is 0.4756636272664083
Epoch 69 loss is 0.41528194383966116
Epoch 79 loss is 0.2998848622620864
Epoch 89 loss is 0.2710656493137349
Epoch 99 loss is 0.2903374686352884
Epoch 109 loss is 0.3910996201783306
Epoch 119 loss is 0.2524314041411569
Epoch 129 loss is 0.2400397004373593
Epoch 139 loss is 0.30319441954601506
Epoch 149 loss is 0.3092964786090183
Epoch 159 loss is 0.25859828261158435
Epoch 169 loss is 0.3205783007902051
Epoch 179 loss is 0.3043531851690775
Epoch 189 loss is 0.4236513177404459
Epoch 199 loss is 0.44608120734258866
Train Acc.:  0.8010938768533948
Val Acc.:  0.7966333418781509
              precision    recall  f1-score   support

           0       0.87      0.96      0.91      1074
           1       0.91      0.66      0.77      1089
           2       0.92      0.85      0.88      1044
           3       0.87      0.80      0.84      1048
           4       0.88      0.51      0.65      1057
           5       0.81      0.88      0.84      1072
           6       0.82      0.72      0.76      1066
           7       0.98      0.96      0.97      1103
           8       0.98      1.00      0.99      1108
           9       0.84      0.87      0.85      1030
          10       0.89      0.88      0.89      1012

   micro avg       0.89      0.83      0.86     11703
   macro avg       0.89      0.83      0.85     11703
weighted avg       0.89      0.83      0.85     11703
 samples avg       0.81      0.83      0.82     11703
</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>task.mark_completed()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>task.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mlmvn-48-20-11" class="level3">
<h3 class="anchored" data-anchor-id="mlmvn-48-20-11">MLMVN [48-20-11]</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>PATH <span class="op">=</span> <span class="bu">str</span>(Path.cwd() <span class="op">/</span> <span class="st">"models/autass-mlmvn_48-20-11.pt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model(nn.Module):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, categories, periodicity):</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.categories <span class="op">=</span> categories</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.periodicity <span class="op">=</span> periodicity</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.first_linear <span class="op">=</span> FirstLayer(<span class="dv">48</span>, <span class="dv">20</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act1 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear_out <span class="op">=</span> OutputLayer(<span class="dv">20</span>, <span class="dv">11</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act2 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Hooks</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.first_layer_hook_handle <span class="op">=</span> <span class="va">self</span>.first_linear.register_full_backward_hook(</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.first_layer_backward_hook</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_hook_handle <span class="op">=</span> <span class="va">self</span>.linear_out.register_full_backward_hook(</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.output_layer_backward_hook</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.first_linear(x)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act1(x)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.linear_out(x)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act2(x)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> first_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"first_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> hidden_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"hidden_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> output_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"output_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> angle2class(<span class="va">self</span>, x: torch.tensor) <span class="op">-&gt;</span> torch.tensor:</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>        tmp <span class="op">=</span> x.angle() <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> np.pi</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>        angle <span class="op">=</span> torch.remainder(tmp, <span class="dv">2</span> <span class="op">*</span> np.pi)</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This will be the discrete output (the number of sector)</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>        o <span class="op">=</span> torch.floor(<span class="va">self</span>.categories <span class="op">*</span> <span class="va">self</span>.periodicity <span class="op">*</span> angle <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> np.pi))</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.remainder(o, <span class="va">self</span>.categories)</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, x):</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a><span class="co">        Performs the prediction task of the network</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a><span class="co">          x: torch.Tensor</span></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a><span class="co">            Input tensor of size ([3])</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a><span class="co">          Most likely class i.e., Label with the highest score</span></span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pass the data through the networks</span></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.forward(x)</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Choose the label with the highest score</span></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># return torch.argmax(output, 1)</span></span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.angle2class(output)</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit(model, X, y, epochs, batch_size, optimizer, criterion, categories, periodicity):</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List of losses for visualization</span></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>    losses <span class="op">=</span> []</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> []</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>    acc_best <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pass the data through the network and compute the loss</span></span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We'll use the whole dataset during the training instead of using batches</span></span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># in to order to keep the code simple for now.</span></span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>        batch_loss <span class="op">=</span> []</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>((X.shape[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span>) <span class="op">//</span> batch_size <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>            start_j <span class="op">=</span> j <span class="op">*</span> batch_size</span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a>            end_j <span class="op">=</span> start_j <span class="op">+</span> batch_size</span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>            xb <span class="op">=</span> X[start_j:end_j]</span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>            yb <span class="op">=</span> y[start_j:end_j]</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> model(xb)</span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(y_pred, yb, categories, periodicity)</span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a>            batch_loss.append((torch.<span class="bu">abs</span>(loss)).detach().numpy())</span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a>            optimizer.step(inputs<span class="op">=</span>xb, layers<span class="op">=</span><span class="bu">list</span>(model.children()))</span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a>        losses.append(<span class="bu">sum</span>(batch_loss) <span class="op">/</span> <span class="bu">len</span>(batch_loss))</span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">9</span>:</span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Epoch </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> loss is </span><span class="sc">{</span>losses[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> model.predict(X)</span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>        scores.append(accuracy(y_pred.squeeze(), y))</span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>        Logger.current_logger().report_scalar(</span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Loss/Acc"</span>, <span class="st">"Loss"</span>, iteration<span class="op">=</span>i, value<span class="op">=</span>losses[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a>        writer.add_scalar(<span class="st">"Loss"</span>, losses[<span class="op">-</span><span class="dv">1</span>], i)</span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a>        Logger.current_logger().report_scalar(</span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Loss/Acc"</span>, <span class="st">"Acc"</span>, iteration<span class="op">=</span>i, value<span class="op">=</span>scores[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a>        writer.add_scalar(<span class="st">"Accuracy"</span>, scores[<span class="op">-</span><span class="dv">1</span>], i)</span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key <span class="kw">in</span> model_dict:</span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> key_layer <span class="kw">in</span> model_dict[key]:</span>
<span id="cb15-105"><a href="#cb15-105" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> key_layer <span class="kw">in</span> [<span class="st">"weights"</span>, <span class="st">"bias"</span>]:</span>
<span id="cb15-106"><a href="#cb15-106" aria-hidden="true" tabindex="-1"></a>                    log_label <span class="op">=</span> <span class="bu">str</span>(key) <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> <span class="bu">str</span>(key_layer)</span>
<span id="cb15-107"><a href="#cb15-107" aria-hidden="true" tabindex="-1"></a>                    log_label.replace(<span class="st">" "</span>, <span class="st">""</span>)</span>
<span id="cb15-108"><a href="#cb15-108" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb15-109"><a href="#cb15-109" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_real"</span>, model_dict[key][key_layer].real, i</span>
<span id="cb15-110"><a href="#cb15-110" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb15-111"><a href="#cb15-111" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb15-112"><a href="#cb15-112" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_imag"</span>, model_dict[key][key_layer].imag, i</span>
<span id="cb15-113"><a href="#cb15-113" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb15-114"><a href="#cb15-114" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb15-115"><a href="#cb15-115" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_mag"</span>, torch.<span class="bu">abs</span>(model_dict[key][key_layer]), i</span>
<span id="cb15-116"><a href="#cb15-116" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb15-117"><a href="#cb15-117" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb15-118"><a href="#cb15-118" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_angle"</span>, torch.angle(model_dict[key][key_layer]), i</span>
<span id="cb15-119"><a href="#cb15-119" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb15-120"><a href="#cb15-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-121"><a href="#cb15-121" aria-hidden="true" tabindex="-1"></a>        <span class="co"># writer.add_histogram("distribution centers", x + n_iter, i)</span></span>
<span id="cb15-122"><a href="#cb15-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> scores[<span class="op">-</span><span class="dv">1</span>] <span class="op">&gt;</span> acc_best:</span>
<span id="cb15-123"><a href="#cb15-123" aria-hidden="true" tabindex="-1"></a>            acc_best <span class="op">=</span> scores[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb15-124"><a href="#cb15-124" aria-hidden="true" tabindex="-1"></a>            torch.save(model.state_dict(), PATH)</span>
<span id="cb15-125"><a href="#cb15-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-126"><a href="#cb15-126" aria-hidden="true" tabindex="-1"></a>    writer.close()</span>
<span id="cb15-127"><a href="#cb15-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> losses, scores</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(categories<span class="op">=</span>categories, periodicity<span class="op">=</span>periodicity)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> ComplexMSELoss.<span class="bu">apply</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> ECL(model.parameters(), lr<span class="op">=</span>lr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>task <span class="op">=</span> Task.init(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    project_name<span class="op">=</span><span class="st">"mlmvn"</span>,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    task_name<span class="op">=</span><span class="st">"SDD-mlmvn-[48-20-11]"</span>,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    tags<span class="op">=</span>[<span class="st">"mlmvn"</span>, <span class="st">"SDD"</span>, <span class="st">"single_run"</span>],</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>writer <span class="op">=</span> SummaryWriter()</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">#  capture a dictionary of hyperparameters with config</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>config_dict <span class="op">=</span> {</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"learning_rate"</span>: <span class="dv">1</span>,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"epochs"</span>: epochs,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"batch_size"</span>: batch_size,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"optim"</span>: <span class="st">"ECL"</span>,</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"categories"</span>: categories,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"periodicity"</span>: periodicity,</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"layer"</span>: <span class="st">"[48-20-11]"</span>,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>task.<span class="ex">connect</span>(config_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ClearML Task: created new task id=2937a1c5c09247d3afefe736b93cce93
ClearML results page: http://194.94.231.172:8080/projects/cdefd6ee85454e49be01962ad715eca0/experiments/2937a1c5c09247d3afefe736b93cce93/output/log</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'learning_rate': 1,
 'epochs': 200,
 'batch_size': 538,
 'optim': 'ECL',
 'categories': 2,
 'periodicity': 1,
 'layer': '[48-20-11]'}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>x_train, x_valid, y_train, y_valid <span class="op">=</span> get_splitted_data(X, y, neuronCats)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>losses, scores <span class="op">=</span> fit(</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    x_train,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    y_train,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    epochs<span class="op">=</span>epochs,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>batch_size,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    optimizer<span class="op">=</span>optimizer,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    criterion<span class="op">=</span>criterion,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    categories<span class="op">=</span>categories,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    periodicity<span class="op">=</span>periodicity,</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>model.load_state_dict(torch.load(PATH))</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(x_train)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> accuracy(y_pred.squeeze(), y_train)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train Acc.: "</span>, acc)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>Logger.current_logger().report_single_value(</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Train Acc."</span>,</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    value<span class="op">=</span>acc,</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(x_valid)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> accuracy(y_pred.squeeze(), y_valid)</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Val Acc.: "</span>, acc)</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>Logger.current_logger().report_single_value(</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Val Acc."</span>,</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    value<span class="op">=</span>acc,</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_valid, y_pred.detach().numpy(), zero_division<span class="op">=</span><span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_9096/3249266730.py:46: UserWarning:

To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>2022-09-20 08:33:02,557 - clearml.frameworks - INFO - Found existing registered model id=c337b94a22444d809d449783726d8ee2 [/home/antonpfeifer/Documents/mlmvn/nbs/examples/autass/models/autass-mlmvn_48-20-11.pt] reusing it.
Epoch 9 loss is 0.1781452279297529
Epoch 19 loss is 0.17121365507481565
Epoch 29 loss is 0.23437533994636411
Epoch 39 loss is 0.249442526042442
Epoch 49 loss is 0.2709493982290144
Epoch 59 loss is 0.22188192248227645
Epoch 69 loss is 0.24606682756213247
Epoch 79 loss is 0.291044741861424
Epoch 89 loss is 0.24921788018106592
Epoch 99 loss is 0.24654104628164147
Epoch 109 loss is 0.2149965350030757
Epoch 119 loss is 0.20888710558226523
Epoch 129 loss is 0.18029340312631476
Epoch 139 loss is 0.21206527705421888
Epoch 149 loss is 0.16859814960066902
Epoch 159 loss is 0.20565043305802141
Epoch 169 loss is 0.20745351853536964
Epoch 179 loss is 0.21776656653704443
Epoch 189 loss is 0.20066393883063724
Epoch 199 loss is 0.17997682184925615
Train Acc.:  0.8812759047985301
Val Acc.:  0.8766982824916688
              precision    recall  f1-score   support

           0       0.96      0.94      0.95      1074
           1       0.90      0.83      0.86      1089
           2       0.97      0.92      0.95      1044
           3       0.94      0.90      0.92      1048
           4       0.89      0.91      0.90      1057
           5       0.86      0.90      0.88      1072
           6       0.83      0.80      0.81      1066
           7       1.00      0.98      0.99      1103
           8       1.00      1.00      1.00      1108
           9       0.87      0.89      0.88      1030
          10       0.94      0.89      0.92      1012

   micro avg       0.92      0.91      0.92     11703
   macro avg       0.92      0.91      0.91     11703
weighted avg       0.93      0.91      0.91     11703
 samples avg       0.89      0.91      0.90     11703
</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>task.mark_completed()</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>task.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mlmvn-48-50-11" class="level3">
<h3 class="anchored" data-anchor-id="mlmvn-48-50-11">MLMVN [48-50-11]</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>PATH <span class="op">=</span> <span class="bu">str</span>(Path.cwd() <span class="op">/</span> <span class="st">"models/autass-mlmvn_48-50-11.pt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model(nn.Module):</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, categories, periodicity):</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.categories <span class="op">=</span> categories</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.periodicity <span class="op">=</span> periodicity</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.first_linear <span class="op">=</span> FirstLayer(<span class="dv">48</span>, <span class="dv">50</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act1 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear_out <span class="op">=</span> OutputLayer(<span class="dv">50</span>, <span class="dv">11</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act2 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Hooks</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.first_layer_hook_handle <span class="op">=</span> <span class="va">self</span>.first_linear.register_full_backward_hook(</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.first_layer_backward_hook</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_hook_handle <span class="op">=</span> <span class="va">self</span>.linear_out.register_full_backward_hook(</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.output_layer_backward_hook</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.first_linear(x)</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act1(x)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.linear_out(x)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act2(x)</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> first_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"first_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> hidden_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"hidden_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> output_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"output_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> angle2class(<span class="va">self</span>, x: torch.tensor) <span class="op">-&gt;</span> torch.tensor:</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>        tmp <span class="op">=</span> x.angle() <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> np.pi</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>        angle <span class="op">=</span> torch.remainder(tmp, <span class="dv">2</span> <span class="op">*</span> np.pi)</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This will be the discrete output (the number of sector)</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>        o <span class="op">=</span> torch.floor(<span class="va">self</span>.categories <span class="op">*</span> <span class="va">self</span>.periodicity <span class="op">*</span> angle <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> np.pi))</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.remainder(o, <span class="va">self</span>.categories)</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, x):</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a><span class="co">        Performs the prediction task of the network</span></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a><span class="co">          x: torch.Tensor</span></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a><span class="co">            Input tensor of size ([3])</span></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a><span class="co">          Most likely class i.e., Label with the highest score</span></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pass the data through the networks</span></span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.forward(x)</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Choose the label with the highest score</span></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># return torch.argmax(output, 1)</span></span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.angle2class(output)</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit(model, X, y, epochs, batch_size, optimizer, criterion, categories, periodicity):</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List of losses for visualization</span></span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>    losses <span class="op">=</span> []</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> []</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>    acc_best <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pass the data through the network and compute the loss</span></span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We'll use the whole dataset during the training instead of using batches</span></span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># in to order to keep the code simple for now.</span></span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>        batch_loss <span class="op">=</span> []</span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>((X.shape[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span>) <span class="op">//</span> batch_size <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>            start_j <span class="op">=</span> j <span class="op">*</span> batch_size</span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>            end_j <span class="op">=</span> start_j <span class="op">+</span> batch_size</span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>            xb <span class="op">=</span> X[start_j:end_j]</span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a>            yb <span class="op">=</span> y[start_j:end_j]</span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> model(xb)</span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(y_pred, yb, categories, periodicity)</span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>            batch_loss.append((torch.<span class="bu">abs</span>(loss)).detach().numpy())</span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>            optimizer.step(inputs<span class="op">=</span>xb, layers<span class="op">=</span><span class="bu">list</span>(model.children()))</span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>        losses.append(<span class="bu">sum</span>(batch_loss) <span class="op">/</span> <span class="bu">len</span>(batch_loss))</span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">9</span>:</span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Epoch </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> loss is </span><span class="sc">{</span>losses[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> model.predict(X)</span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>        scores.append(accuracy(y_pred.squeeze(), y))</span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a>        Logger.current_logger().report_scalar(</span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Loss/Acc"</span>, <span class="st">"Loss"</span>, iteration<span class="op">=</span>i, value<span class="op">=</span>losses[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a>        writer.add_scalar(<span class="st">"Loss"</span>, losses[<span class="op">-</span><span class="dv">1</span>], i)</span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a>        Logger.current_logger().report_scalar(</span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Loss/Acc"</span>, <span class="st">"Acc"</span>, iteration<span class="op">=</span>i, value<span class="op">=</span>scores[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a>        writer.add_scalar(<span class="st">"Accuracy"</span>, scores[<span class="op">-</span><span class="dv">1</span>], i)</span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key <span class="kw">in</span> model_dict:</span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> key_layer <span class="kw">in</span> model_dict[key]:</span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> key_layer <span class="kw">in</span> [<span class="st">"weights"</span>, <span class="st">"bias"</span>]:</span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a>                    log_label <span class="op">=</span> <span class="bu">str</span>(key) <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> <span class="bu">str</span>(key_layer)</span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a>                    log_label.replace(<span class="st">" "</span>, <span class="st">""</span>)</span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_real"</span>, model_dict[key][key_layer].real, i</span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb25-111"><a href="#cb25-111" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb25-112"><a href="#cb25-112" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_imag"</span>, model_dict[key][key_layer].imag, i</span>
<span id="cb25-113"><a href="#cb25-113" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb25-114"><a href="#cb25-114" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb25-115"><a href="#cb25-115" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_mag"</span>, torch.<span class="bu">abs</span>(model_dict[key][key_layer]), i</span>
<span id="cb25-116"><a href="#cb25-116" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb25-117"><a href="#cb25-117" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb25-118"><a href="#cb25-118" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_angle"</span>, torch.angle(model_dict[key][key_layer]), i</span>
<span id="cb25-119"><a href="#cb25-119" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb25-120"><a href="#cb25-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-121"><a href="#cb25-121" aria-hidden="true" tabindex="-1"></a>        <span class="co"># writer.add_histogram("distribution centers", x + n_iter, i)</span></span>
<span id="cb25-122"><a href="#cb25-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> scores[<span class="op">-</span><span class="dv">1</span>] <span class="op">&gt;</span> acc_best:</span>
<span id="cb25-123"><a href="#cb25-123" aria-hidden="true" tabindex="-1"></a>            acc_best <span class="op">=</span> scores[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb25-124"><a href="#cb25-124" aria-hidden="true" tabindex="-1"></a>            torch.save(model.state_dict(), PATH)</span>
<span id="cb25-125"><a href="#cb25-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-126"><a href="#cb25-126" aria-hidden="true" tabindex="-1"></a>    writer.close()</span>
<span id="cb25-127"><a href="#cb25-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> losses, scores</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(categories<span class="op">=</span>categories, periodicity<span class="op">=</span>periodicity)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> ComplexMSELoss.<span class="bu">apply</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> ECL(model.parameters(), lr<span class="op">=</span>lr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>task <span class="op">=</span> Task.init(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    project_name<span class="op">=</span><span class="st">"mlmvn"</span>,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    task_name<span class="op">=</span><span class="st">"SDD-mlmvn-[48-50-11]"</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    tags<span class="op">=</span>[<span class="st">"mlmvn"</span>, <span class="st">"SDD"</span>, <span class="st">"single_run"</span>],</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>writer <span class="op">=</span> SummaryWriter()</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co">#  capture a dictionary of hyperparameters with config</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>config_dict <span class="op">=</span> {</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"learning_rate"</span>: <span class="dv">1</span>,</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"epochs"</span>: epochs,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"batch_size"</span>: batch_size,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"optim"</span>: <span class="st">"ECL"</span>,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"categories"</span>: categories,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"periodicity"</span>: periodicity,</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"layer"</span>: <span class="st">"[48-50-11]"</span>,</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>task.<span class="ex">connect</span>(config_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ClearML Task: created new task id=b9c663cb49f645d3b526ff62b971b678
ClearML results page: http://194.94.231.172:8080/projects/cdefd6ee85454e49be01962ad715eca0/experiments/b9c663cb49f645d3b526ff62b971b678/output/log</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'learning_rate': 1,
 'epochs': 200,
 'batch_size': 538,
 'optim': 'ECL',
 'categories': 2,
 'periodicity': 1,
 'layer': '[48-50-11]'}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>x_train, x_valid, y_train, y_valid <span class="op">=</span> get_splitted_data(X, y, neuronCats)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>losses, scores <span class="op">=</span> fit(</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    x_train,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    y_train,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    epochs<span class="op">=</span>epochs,</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>batch_size,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    optimizer<span class="op">=</span>optimizer,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    criterion<span class="op">=</span>criterion,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    categories<span class="op">=</span>categories,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    periodicity<span class="op">=</span>periodicity,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>model.load_state_dict(torch.load(PATH))</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(x_train)</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> accuracy(y_pred.squeeze(), y_train)</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train Acc.: "</span>, acc)</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>Logger.current_logger().report_single_value(</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Train Acc."</span>,</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    value<span class="op">=</span>acc,</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(x_valid)</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> accuracy(y_pred.squeeze(), y_valid)</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Val Acc.: "</span>, acc)</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>Logger.current_logger().report_single_value(</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Val Acc."</span>,</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    value<span class="op">=</span>acc,</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_valid, y_pred.detach().numpy(), zero_division<span class="op">=</span><span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_9096/3249266730.py:46: UserWarning:

To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>2022-09-20 08:36:28,294 - clearml.frameworks - INFO - Found existing registered model id=bb96e63090904339bf87c4852d30bdb6 [/home/antonpfeifer/Documents/mlmvn/nbs/examples/autass/models/autass-mlmvn_48-50-11.pt] reusing it.
Epoch 9 loss is 0.12631168614962632
Epoch 19 loss is 0.08741677563113538
Epoch 29 loss is 0.07765135114449577
Epoch 39 loss is 0.07199543979859238
Epoch 49 loss is 0.05459176181501563
Epoch 59 loss is 0.054154946830923104
Epoch 69 loss is 0.0498279498984762
Epoch 79 loss is 0.04969739252919254
Epoch 89 loss is 0.05646039586774165
Epoch 99 loss is 0.05206559631806764
Epoch 109 loss is 0.04809522582296451
Epoch 119 loss is 0.0522341919664429
Epoch 129 loss is 0.0495262401204281
Epoch 139 loss is 0.04954010092306082
Epoch 149 loss is 0.061976915229967955
Epoch 159 loss is 0.05182441637727222
Epoch 169 loss is 0.05091017378293241
Epoch 179 loss is 0.0561740020607465
Epoch 189 loss is 0.06101975489402404
Epoch 199 loss is 0.06845130197965535
Train Acc.:  0.9619706875186942
Val Acc.:  0.9557378449970093
              precision    recall  f1-score   support

           0       1.00      0.97      0.98      1074
           1       0.95      0.92      0.93      1089
           2       0.99      0.98      0.98      1044
           3       0.99      0.98      0.98      1048
           4       0.97      0.96      0.97      1057
           5       0.95      0.94      0.95      1072
           6       0.95      0.94      0.94      1066
           7       1.00      0.99      1.00      1103
           8       1.00      1.00      1.00      1108
           9       0.96      0.95      0.95      1030
          10       0.99      0.97      0.98      1012

   micro avg       0.98      0.96      0.97     11703
   macro avg       0.98      0.96      0.97     11703
weighted avg       0.98      0.96      0.97     11703
 samples avg       0.96      0.96      0.96     11703
</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>task.mark_completed()</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>task.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mlmvn-48-100-11" class="level3">
<h3 class="anchored" data-anchor-id="mlmvn-48-100-11">MLMVN [48-100-11]</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>PATH <span class="op">=</span> <span class="bu">str</span>(Path.cwd() <span class="op">/</span> <span class="st">"models/autass-mlmvn_48-100-11.pt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model(nn.Module):</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, categories, periodicity):</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.categories <span class="op">=</span> categories</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.periodicity <span class="op">=</span> periodicity</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.first_linear <span class="op">=</span> FirstLayer(<span class="dv">48</span>, <span class="dv">100</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act1 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear_out <span class="op">=</span> OutputLayer(<span class="dv">100</span>, <span class="dv">11</span>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act2 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Hooks</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.first_layer_hook_handle <span class="op">=</span> <span class="va">self</span>.first_linear.register_full_backward_hook(</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.first_layer_backward_hook</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_hook_handle <span class="op">=</span> <span class="va">self</span>.linear_out.register_full_backward_hook(</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.output_layer_backward_hook</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.first_linear(x)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act1(x)</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.linear_out(x)</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act2(x)</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> first_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"first_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> hidden_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"hidden_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> output_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"output_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> angle2class(<span class="va">self</span>, x: torch.tensor) <span class="op">-&gt;</span> torch.tensor:</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>        tmp <span class="op">=</span> x.angle() <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> np.pi</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>        angle <span class="op">=</span> torch.remainder(tmp, <span class="dv">2</span> <span class="op">*</span> np.pi)</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This will be the discrete output (the number of sector)</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>        o <span class="op">=</span> torch.floor(<span class="va">self</span>.categories <span class="op">*</span> <span class="va">self</span>.periodicity <span class="op">*</span> angle <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> np.pi))</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.remainder(o, <span class="va">self</span>.categories)</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, x):</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a><span class="co">        Performs the prediction task of the network</span></span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a><span class="co">          x: torch.Tensor</span></span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a><span class="co">            Input tensor of size ([3])</span></span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a><span class="co">          Most likely class i.e., Label with the highest score</span></span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pass the data through the networks</span></span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.forward(x)</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Choose the label with the highest score</span></span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># return torch.argmax(output, 1)</span></span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.angle2class(output)</span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit(model, X, y, epochs, batch_size, optimizer, criterion, categories, periodicity):</span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List of losses for visualization</span></span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>    losses <span class="op">=</span> []</span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> []</span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>    acc_best <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pass the data through the network and compute the loss</span></span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We'll use the whole dataset during the training instead of using batches</span></span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># in to order to keep the code simple for now.</span></span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a>        batch_loss <span class="op">=</span> []</span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>((X.shape[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span>) <span class="op">//</span> batch_size <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a>            start_j <span class="op">=</span> j <span class="op">*</span> batch_size</span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a>            end_j <span class="op">=</span> start_j <span class="op">+</span> batch_size</span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a>            xb <span class="op">=</span> X[start_j:end_j]</span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a>            yb <span class="op">=</span> y[start_j:end_j]</span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> model(xb)</span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(y_pred, yb, categories, periodicity)</span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a>            batch_loss.append((torch.<span class="bu">abs</span>(loss)).detach().numpy())</span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a>            optimizer.step(inputs<span class="op">=</span>xb, layers<span class="op">=</span><span class="bu">list</span>(model.children()))</span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a>        losses.append(<span class="bu">sum</span>(batch_loss) <span class="op">/</span> <span class="bu">len</span>(batch_loss))</span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">9</span>:</span>
<span id="cb35-90"><a href="#cb35-90" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Epoch </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> loss is </span><span class="sc">{</span>losses[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-91"><a href="#cb35-91" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> model.predict(X)</span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a>        scores.append(accuracy(y_pred.squeeze(), y))</span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a>        Logger.current_logger().report_scalar(</span>
<span id="cb35-95"><a href="#cb35-95" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Loss/Acc"</span>, <span class="st">"Loss"</span>, iteration<span class="op">=</span>i, value<span class="op">=</span>losses[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb35-96"><a href="#cb35-96" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a>        writer.add_scalar(<span class="st">"Loss"</span>, losses[<span class="op">-</span><span class="dv">1</span>], i)</span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a>        Logger.current_logger().report_scalar(</span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Loss/Acc"</span>, <span class="st">"Acc"</span>, iteration<span class="op">=</span>i, value<span class="op">=</span>scores[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-101"><a href="#cb35-101" aria-hidden="true" tabindex="-1"></a>        writer.add_scalar(<span class="st">"Accuracy"</span>, scores[<span class="op">-</span><span class="dv">1</span>], i)</span>
<span id="cb35-102"><a href="#cb35-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-103"><a href="#cb35-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key <span class="kw">in</span> model_dict:</span>
<span id="cb35-104"><a href="#cb35-104" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> key_layer <span class="kw">in</span> model_dict[key]:</span>
<span id="cb35-105"><a href="#cb35-105" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> key_layer <span class="kw">in</span> [<span class="st">"weights"</span>, <span class="st">"bias"</span>]:</span>
<span id="cb35-106"><a href="#cb35-106" aria-hidden="true" tabindex="-1"></a>                    log_label <span class="op">=</span> <span class="bu">str</span>(key) <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> <span class="bu">str</span>(key_layer)</span>
<span id="cb35-107"><a href="#cb35-107" aria-hidden="true" tabindex="-1"></a>                    log_label.replace(<span class="st">" "</span>, <span class="st">""</span>)</span>
<span id="cb35-108"><a href="#cb35-108" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb35-109"><a href="#cb35-109" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_real"</span>, model_dict[key][key_layer].real, i</span>
<span id="cb35-110"><a href="#cb35-110" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb35-111"><a href="#cb35-111" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb35-112"><a href="#cb35-112" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_imag"</span>, model_dict[key][key_layer].imag, i</span>
<span id="cb35-113"><a href="#cb35-113" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb35-114"><a href="#cb35-114" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb35-115"><a href="#cb35-115" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_mag"</span>, torch.<span class="bu">abs</span>(model_dict[key][key_layer]), i</span>
<span id="cb35-116"><a href="#cb35-116" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb35-117"><a href="#cb35-117" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb35-118"><a href="#cb35-118" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_angle"</span>, torch.angle(model_dict[key][key_layer]), i</span>
<span id="cb35-119"><a href="#cb35-119" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb35-120"><a href="#cb35-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-121"><a href="#cb35-121" aria-hidden="true" tabindex="-1"></a>        <span class="co"># writer.add_histogram("distribution centers", x + n_iter, i)</span></span>
<span id="cb35-122"><a href="#cb35-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> scores[<span class="op">-</span><span class="dv">1</span>] <span class="op">&gt;</span> acc_best:</span>
<span id="cb35-123"><a href="#cb35-123" aria-hidden="true" tabindex="-1"></a>            acc_best <span class="op">=</span> scores[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb35-124"><a href="#cb35-124" aria-hidden="true" tabindex="-1"></a>            torch.save(model.state_dict(), PATH)</span>
<span id="cb35-125"><a href="#cb35-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-126"><a href="#cb35-126" aria-hidden="true" tabindex="-1"></a>    writer.close()</span>
<span id="cb35-127"><a href="#cb35-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> losses, scores</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(categories<span class="op">=</span>categories, periodicity<span class="op">=</span>periodicity)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> ComplexMSELoss.<span class="bu">apply</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> ECL(model.parameters(), lr<span class="op">=</span>lr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>task <span class="op">=</span> Task.init(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    project_name<span class="op">=</span><span class="st">"mlmvn"</span>,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    task_name<span class="op">=</span><span class="st">"SDD-mlmvn-[48-100-11]"</span>,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    tags<span class="op">=</span>[<span class="st">"mlmvn"</span>, <span class="st">"SDD"</span>, <span class="st">"single_run"</span>],</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>writer <span class="op">=</span> SummaryWriter()</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co">#  capture a dictionary of hyperparameters with config</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>config_dict <span class="op">=</span> {</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"learning_rate"</span>: <span class="dv">1</span>,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"epochs"</span>: epochs,</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"batch_size"</span>: batch_size,</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"optim"</span>: <span class="st">"ECL"</span>,</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"categories"</span>: categories,</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"periodicity"</span>: periodicity,</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"layer"</span>: <span class="st">"[48-100-11]"</span>,</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>task.<span class="ex">connect</span>(config_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ClearML Task: created new task id=77bda608f5dd4cbf9fb5bf146c9bcdbe
ClearML results page: http://194.94.231.172:8080/projects/cdefd6ee85454e49be01962ad715eca0/experiments/77bda608f5dd4cbf9fb5bf146c9bcdbe/output/log</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'learning_rate': 1,
 'epochs': 200,
 'batch_size': 538,
 'optim': 'ECL',
 'categories': 2,
 'periodicity': 1,
 'layer': '[48-100-11]'}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>x_train, x_valid, y_train, y_valid <span class="op">=</span> get_splitted_data(X, y, neuronCats)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>losses, scores <span class="op">=</span> fit(</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    x_train,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    y_train,</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    epochs<span class="op">=</span>epochs,</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>batch_size,</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    optimizer<span class="op">=</span>optimizer,</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    criterion<span class="op">=</span>criterion,</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    categories<span class="op">=</span>categories,</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    periodicity<span class="op">=</span>periodicity,</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>model.load_state_dict(torch.load(PATH))</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(x_train)</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> accuracy(y_pred.squeeze(), y_train)</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train Acc.: "</span>, acc)</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>Logger.current_logger().report_single_value(</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Train Acc."</span>,</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    value<span class="op">=</span>acc,</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(x_valid)</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> accuracy(y_pred.squeeze(), y_valid)</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Val Acc.: "</span>, acc)</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>Logger.current_logger().report_single_value(</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Val Acc."</span>,</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>    value<span class="op">=</span>acc,</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_valid, y_pred.detach().numpy(), zero_division<span class="op">=</span><span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_9096/3249266730.py:46: UserWarning:

To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).

/tmp/ipykernel_9096/3249266730.py:46: UserWarning:

To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>2022-09-20 08:40:51,411 - clearml.frameworks - INFO - Found existing registered model id=0f73e6db01fc42988672e4f44c0add5f [/home/antonpfeifer/Documents/mlmvn/nbs/examples/autass/models/autass-mlmvn_48-100-11.pt] reusing it.
Epoch 9 loss is 0.09760215896283031
Epoch 19 loss is 0.07483332226588477
Epoch 29 loss is 0.06169817582724667
Epoch 39 loss is 0.04806632873441776
Epoch 49 loss is 0.050257943968239405
Epoch 59 loss is 0.045243461048822334
Epoch 69 loss is 0.03916302966121763
Epoch 79 loss is 0.03600947264373011
Epoch 89 loss is 0.0327954003325785
Epoch 99 loss is 0.034495561806988345
Epoch 109 loss is 0.02976081583721455
Epoch 119 loss is 0.03207888606505858
Epoch 129 loss is 0.029421696533450108
Epoch 139 loss is 0.02886477329200674
Epoch 149 loss is 0.028011108627125445
Epoch 159 loss is 0.02746762018733399
Epoch 169 loss is 0.029159449466333746
Epoch 179 loss is 0.028677871059498893
Epoch 189 loss is 0.026269004340911915
Epoch 199 loss is 0.02659348237350445
Train Acc.:  0.9820749476562833
Val Acc.:  0.9690677604033154
              precision    recall  f1-score   support

           0       0.99      0.98      0.98      1074
           1       0.96      0.96      0.96      1089
           2       1.00      0.99      0.99      1044
           3       1.00      0.99      0.99      1048
           4       0.97      0.97      0.97      1057
           5       0.96      0.96      0.96      1072
           6       0.97      0.95      0.96      1066
           7       1.00      1.00      1.00      1103
           8       1.00      1.00      1.00      1108
           9       0.97      0.97      0.97      1030
          10       0.99      0.98      0.98      1012

   micro avg       0.98      0.98      0.98     11703
   macro avg       0.98      0.98      0.98     11703
weighted avg       0.98      0.98      0.98     11703
 samples avg       0.97      0.98      0.97     11703
</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>task.mark_completed()</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>task.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="multi-layer" class="level2">
<h2 class="anchored" data-anchor-id="multi-layer">Multi Layer</h2>
<section id="mlmvn-48-10-10-11" class="level3">
<h3 class="anchored" data-anchor-id="mlmvn-48-10-10-11">MLMVN [48-10-10-11]</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>PATH <span class="op">=</span> <span class="bu">str</span>(Path.cwd() <span class="op">/</span> <span class="st">"models/autass-mlmvn_48-10-10-11.pt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model(nn.Module):</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, categories, periodicity):</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.categories <span class="op">=</span> categories</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.periodicity <span class="op">=</span> periodicity</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.first_linear <span class="op">=</span> FirstLayer(<span class="dv">48</span>, <span class="dv">10</span>)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act1 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hidden_layer <span class="op">=</span> HiddenLayer(<span class="dv">10</span>, <span class="dv">10</span>)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act2 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear_out <span class="op">=</span> OutputLayer(<span class="dv">10</span>, <span class="dv">11</span>)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act3 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Hooks</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.first_layer_hook_handle <span class="op">=</span> <span class="va">self</span>.first_linear.register_full_backward_hook(</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.first_layer_backward_hook</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hidden_layer_hook_handle <span class="op">=</span> <span class="va">self</span>.hidden_layer.register_full_backward_hook(</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.hidden_layer_backward_hook</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_hook_handle <span class="op">=</span> <span class="va">self</span>.linear_out.register_full_backward_hook(</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.output_layer_backward_hook</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.first_linear(x)</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act1(x)</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.hidden_layer(x)</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act2(x)</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.linear_out(x)</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act3(x)</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> first_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"first_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> hidden_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"hidden_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> output_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"output_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> angle2class(<span class="va">self</span>, x: torch.tensor) <span class="op">-&gt;</span> torch.tensor:</span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a>        tmp <span class="op">=</span> x.angle() <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> np.pi</span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a>        angle <span class="op">=</span> torch.remainder(tmp, <span class="dv">2</span> <span class="op">*</span> np.pi)</span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This will be the discrete output (the number of sector)</span></span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a>        o <span class="op">=</span> torch.floor(<span class="va">self</span>.categories <span class="op">*</span> <span class="va">self</span>.periodicity <span class="op">*</span> angle <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> np.pi))</span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.remainder(o, <span class="va">self</span>.categories)</span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, x):</span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a><span class="co">        Performs the prediction task of the network</span></span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a><span class="co">          x: torch.Tensor</span></span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a><span class="co">            Input tensor of size ([3])</span></span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a><span class="co">          Most likely class i.e., Label with the highest score</span></span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pass the data through the networks</span></span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.forward(x)</span>
<span id="cb45-62"><a href="#cb45-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-63"><a href="#cb45-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Choose the label with the highest score</span></span>
<span id="cb45-64"><a href="#cb45-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># return torch.argmax(output, 1)</span></span>
<span id="cb45-65"><a href="#cb45-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.angle2class(output)</span>
<span id="cb45-66"><a href="#cb45-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-67"><a href="#cb45-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-68"><a href="#cb45-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit(model, X, y, epochs, batch_size, optimizer, criterion, categories, periodicity):</span>
<span id="cb45-69"><a href="#cb45-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List of losses for visualization</span></span>
<span id="cb45-70"><a href="#cb45-70" aria-hidden="true" tabindex="-1"></a>    losses <span class="op">=</span> []</span>
<span id="cb45-71"><a href="#cb45-71" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> []</span>
<span id="cb45-72"><a href="#cb45-72" aria-hidden="true" tabindex="-1"></a>    acc_best <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb45-73"><a href="#cb45-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-74"><a href="#cb45-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb45-75"><a href="#cb45-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pass the data through the network and compute the loss</span></span>
<span id="cb45-76"><a href="#cb45-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We'll use the whole dataset during the training instead of using batches</span></span>
<span id="cb45-77"><a href="#cb45-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># in to order to keep the code simple for now.</span></span>
<span id="cb45-78"><a href="#cb45-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-79"><a href="#cb45-79" aria-hidden="true" tabindex="-1"></a>        batch_loss <span class="op">=</span> []</span>
<span id="cb45-80"><a href="#cb45-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-81"><a href="#cb45-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>((X.shape[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span>) <span class="op">//</span> batch_size <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb45-82"><a href="#cb45-82" aria-hidden="true" tabindex="-1"></a>            start_j <span class="op">=</span> j <span class="op">*</span> batch_size</span>
<span id="cb45-83"><a href="#cb45-83" aria-hidden="true" tabindex="-1"></a>            end_j <span class="op">=</span> start_j <span class="op">+</span> batch_size</span>
<span id="cb45-84"><a href="#cb45-84" aria-hidden="true" tabindex="-1"></a>            xb <span class="op">=</span> X[start_j:end_j]</span>
<span id="cb45-85"><a href="#cb45-85" aria-hidden="true" tabindex="-1"></a>            yb <span class="op">=</span> y[start_j:end_j]</span>
<span id="cb45-86"><a href="#cb45-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-87"><a href="#cb45-87" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> model(xb)</span>
<span id="cb45-88"><a href="#cb45-88" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(y_pred, yb, categories, periodicity)</span>
<span id="cb45-89"><a href="#cb45-89" aria-hidden="true" tabindex="-1"></a>            batch_loss.append((torch.<span class="bu">abs</span>(loss)).detach().numpy())</span>
<span id="cb45-90"><a href="#cb45-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-91"><a href="#cb45-91" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb45-92"><a href="#cb45-92" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb45-93"><a href="#cb45-93" aria-hidden="true" tabindex="-1"></a>            optimizer.step(inputs<span class="op">=</span>xb, layers<span class="op">=</span><span class="bu">list</span>(model.children()))</span>
<span id="cb45-94"><a href="#cb45-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-95"><a href="#cb45-95" aria-hidden="true" tabindex="-1"></a>        losses.append(<span class="bu">sum</span>(batch_loss) <span class="op">/</span> <span class="bu">len</span>(batch_loss))</span>
<span id="cb45-96"><a href="#cb45-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">9</span>:</span>
<span id="cb45-97"><a href="#cb45-97" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Epoch </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> loss is </span><span class="sc">{</span>losses[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb45-98"><a href="#cb45-98" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> model.predict(X)</span>
<span id="cb45-99"><a href="#cb45-99" aria-hidden="true" tabindex="-1"></a>        scores.append(accuracy(y_pred.squeeze(), y))</span>
<span id="cb45-100"><a href="#cb45-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-101"><a href="#cb45-101" aria-hidden="true" tabindex="-1"></a>        Logger.current_logger().report_scalar(</span>
<span id="cb45-102"><a href="#cb45-102" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Loss/Acc"</span>, <span class="st">"Loss"</span>, iteration<span class="op">=</span>i, value<span class="op">=</span>losses[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb45-103"><a href="#cb45-103" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-104"><a href="#cb45-104" aria-hidden="true" tabindex="-1"></a>        writer.add_scalar(<span class="st">"Loss"</span>, losses[<span class="op">-</span><span class="dv">1</span>], i)</span>
<span id="cb45-105"><a href="#cb45-105" aria-hidden="true" tabindex="-1"></a>        Logger.current_logger().report_scalar(</span>
<span id="cb45-106"><a href="#cb45-106" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Loss/Acc"</span>, <span class="st">"Acc"</span>, iteration<span class="op">=</span>i, value<span class="op">=</span>scores[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb45-107"><a href="#cb45-107" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-108"><a href="#cb45-108" aria-hidden="true" tabindex="-1"></a>        writer.add_scalar(<span class="st">"Accuracy"</span>, scores[<span class="op">-</span><span class="dv">1</span>], i)</span>
<span id="cb45-109"><a href="#cb45-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-110"><a href="#cb45-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key <span class="kw">in</span> model_dict:</span>
<span id="cb45-111"><a href="#cb45-111" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> key_layer <span class="kw">in</span> model_dict[key]:</span>
<span id="cb45-112"><a href="#cb45-112" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> key_layer <span class="kw">in</span> [<span class="st">"weights"</span>, <span class="st">"bias"</span>]:</span>
<span id="cb45-113"><a href="#cb45-113" aria-hidden="true" tabindex="-1"></a>                    log_label <span class="op">=</span> <span class="bu">str</span>(key) <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> <span class="bu">str</span>(key_layer)</span>
<span id="cb45-114"><a href="#cb45-114" aria-hidden="true" tabindex="-1"></a>                    log_label.replace(<span class="st">" "</span>, <span class="st">""</span>)</span>
<span id="cb45-115"><a href="#cb45-115" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb45-116"><a href="#cb45-116" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_real"</span>, model_dict[key][key_layer].real, i</span>
<span id="cb45-117"><a href="#cb45-117" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb45-118"><a href="#cb45-118" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb45-119"><a href="#cb45-119" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_imag"</span>, model_dict[key][key_layer].imag, i</span>
<span id="cb45-120"><a href="#cb45-120" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb45-121"><a href="#cb45-121" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb45-122"><a href="#cb45-122" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_mag"</span>, torch.<span class="bu">abs</span>(model_dict[key][key_layer]), i</span>
<span id="cb45-123"><a href="#cb45-123" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb45-124"><a href="#cb45-124" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb45-125"><a href="#cb45-125" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_angle"</span>, torch.angle(model_dict[key][key_layer]), i</span>
<span id="cb45-126"><a href="#cb45-126" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb45-127"><a href="#cb45-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-128"><a href="#cb45-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> scores[<span class="op">-</span><span class="dv">1</span>] <span class="op">&gt;</span> acc_best:</span>
<span id="cb45-129"><a href="#cb45-129" aria-hidden="true" tabindex="-1"></a>            acc_best <span class="op">=</span> scores[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb45-130"><a href="#cb45-130" aria-hidden="true" tabindex="-1"></a>            torch.save(model.state_dict(), PATH)</span>
<span id="cb45-131"><a href="#cb45-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-132"><a href="#cb45-132" aria-hidden="true" tabindex="-1"></a>    writer.close()</span>
<span id="cb45-133"><a href="#cb45-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> losses, scores</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(categories<span class="op">=</span>categories, periodicity<span class="op">=</span>periodicity)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> ComplexMSELoss.<span class="bu">apply</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> ECL(model.parameters(), lr<span class="op">=</span>lr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>task <span class="op">=</span> Task.init(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    project_name<span class="op">=</span><span class="st">"mlmvn"</span>,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    task_name<span class="op">=</span><span class="st">"SDD-mlmvn-[48-10-10-11]"</span>,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    tags<span class="op">=</span>[<span class="st">"mlmvn"</span>, <span class="st">"SDD"</span>, <span class="st">"single_run"</span>],</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>writer <span class="op">=</span> SummaryWriter()</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co">#  capture a dictionary of hyperparameters with config</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>config_dict <span class="op">=</span> {</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"learning_rate"</span>: <span class="dv">1</span>,</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"epochs"</span>: epochs,</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"batch_size"</span>: batch_size,</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"optim"</span>: <span class="st">"ECL"</span>,</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"categories"</span>: categories,</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"periodicity"</span>: periodicity,</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"layer"</span>: <span class="st">"[48-10-10-11]"</span>,</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>task.<span class="ex">connect</span>(config_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ClearML Task: created new task id=7aa1a5aeeab040fda27730a9cb90d8ad
ClearML results page: http://194.94.231.172:8080/projects/cdefd6ee85454e49be01962ad715eca0/experiments/7aa1a5aeeab040fda27730a9cb90d8ad/output/log</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'learning_rate': 1,
 'epochs': 200,
 'batch_size': 538,
 'optim': 'ECL',
 'categories': 2,
 'periodicity': 1,
 'layer': '[48-10-10-11]'}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>x_train, x_valid, y_train, y_valid <span class="op">=</span> get_splitted_data(X, y, neuronCats)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>losses, scores <span class="op">=</span> fit(</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    x_train,</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    y_train,</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    epochs<span class="op">=</span>epochs,</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>batch_size,</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    optimizer<span class="op">=</span>optimizer,</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>    criterion<span class="op">=</span>criterion,</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    categories<span class="op">=</span>categories,</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    periodicity<span class="op">=</span>periodicity,</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>model.load_state_dict(torch.load(PATH))</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(x_train)</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> accuracy(y_pred.squeeze(), y_train)</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train Acc.: "</span>, acc)</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>Logger.current_logger().report_single_value(</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Train Acc."</span>,</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>    value<span class="op">=</span>acc,</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(x_valid)</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> accuracy(y_pred.squeeze(), y_valid)</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Val Acc.: "</span>, acc)</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>Logger.current_logger().report_single_value(</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Val Acc."</span>,</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>    value<span class="op">=</span>acc,</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_valid, y_pred.detach().numpy(), zero_division<span class="op">=</span><span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_9096/3249266730.py:46: UserWarning:

To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 9 loss is 0.6741966148101034
Epoch 19 loss is 0.6345819678996693
Epoch 29 loss is 0.6163333298521995
Epoch 39 loss is 0.5973288617286425
Epoch 49 loss is 0.5657958380010314
Epoch 59 loss is 0.5930215843207252
Epoch 69 loss is 0.614107440452483
Epoch 79 loss is 0.6680024372385054
Epoch 89 loss is 0.670419685702236
Epoch 99 loss is 0.6396620484680041
Epoch 109 loss is 0.7318713292921706
Epoch 119 loss is 0.7326499528623525
Epoch 129 loss is 0.7676124397701742
Epoch 139 loss is 0.7363896056980302
Epoch 149 loss is 0.7518392231032288
Epoch 159 loss is 0.6876373192278051
Epoch 169 loss is 0.684599693905956
Epoch 179 loss is 0.6865932359686486
Epoch 189 loss is 0.6739611875627026
Epoch 199 loss is 0.6541066273988838
Train Acc.:  0.3464940392257403
Val Acc.:  0.3492266940100829
              precision    recall  f1-score   support

           0       0.56      0.70      0.63      1074
           1       0.59      0.43      0.50      1089
           2       0.59      0.23      0.33      1044
           3       0.76      0.43      0.55      1048
           4       0.57      0.27      0.36      1057
           5       0.59      0.61      0.60      1072
           6       0.40      0.08      0.13      1066
           7       0.92      0.80      0.86      1103
           8       0.97      0.96      0.97      1108
           9       0.17      0.03      0.05      1030
          10       0.49      0.28      0.36      1012

   micro avg       0.67      0.44      0.53     11703
   macro avg       0.60      0.44      0.48     11703
weighted avg       0.60      0.44      0.49     11703
 samples avg       0.39      0.44      0.41     11703
</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>task.mark_completed()</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>task.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mlmvn-48-20-20-11" class="level3">
<h3 class="anchored" data-anchor-id="mlmvn-48-20-20-11">MLMVN [48-20-20-11]</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>PATH <span class="op">=</span> <span class="bu">str</span>(Path.cwd() <span class="op">/</span> <span class="st">"models/autass-mlmvn_48-20-20-11.pt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model(nn.Module):</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, categories, periodicity):</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.categories <span class="op">=</span> categories</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.periodicity <span class="op">=</span> periodicity</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.first_linear <span class="op">=</span> FirstLayer(<span class="dv">48</span>, <span class="dv">20</span>)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act1 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hidden_layer <span class="op">=</span> HiddenLayer(<span class="dv">20</span>, <span class="dv">20</span>)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act2 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear_out <span class="op">=</span> OutputLayer(<span class="dv">20</span>, <span class="dv">11</span>)</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act3 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Hooks</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.first_layer_hook_handle <span class="op">=</span> <span class="va">self</span>.first_linear.register_full_backward_hook(</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.first_layer_backward_hook</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hidden_layer_hook_handle <span class="op">=</span> <span class="va">self</span>.hidden_layer.register_full_backward_hook(</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.hidden_layer_backward_hook</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_hook_handle <span class="op">=</span> <span class="va">self</span>.linear_out.register_full_backward_hook(</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.output_layer_backward_hook</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.first_linear(x)</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act1(x)</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.hidden_layer(x)</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act2(x)</span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.linear_out(x)</span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act3(x)</span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> first_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"first_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> hidden_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"hidden_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> output_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"output_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> angle2class(<span class="va">self</span>, x: torch.tensor) <span class="op">-&gt;</span> torch.tensor:</span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a>        tmp <span class="op">=</span> x.angle() <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> np.pi</span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a>        angle <span class="op">=</span> torch.remainder(tmp, <span class="dv">2</span> <span class="op">*</span> np.pi)</span>
<span id="cb55-44"><a href="#cb55-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-45"><a href="#cb55-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This will be the discrete output (the number of sector)</span></span>
<span id="cb55-46"><a href="#cb55-46" aria-hidden="true" tabindex="-1"></a>        o <span class="op">=</span> torch.floor(<span class="va">self</span>.categories <span class="op">*</span> <span class="va">self</span>.periodicity <span class="op">*</span> angle <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> np.pi))</span>
<span id="cb55-47"><a href="#cb55-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.remainder(o, <span class="va">self</span>.categories)</span>
<span id="cb55-48"><a href="#cb55-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-49"><a href="#cb55-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, x):</span>
<span id="cb55-50"><a href="#cb55-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb55-51"><a href="#cb55-51" aria-hidden="true" tabindex="-1"></a><span class="co">        Performs the prediction task of the network</span></span>
<span id="cb55-52"><a href="#cb55-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-53"><a href="#cb55-53" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb55-54"><a href="#cb55-54" aria-hidden="true" tabindex="-1"></a><span class="co">          x: torch.Tensor</span></span>
<span id="cb55-55"><a href="#cb55-55" aria-hidden="true" tabindex="-1"></a><span class="co">            Input tensor of size ([3])</span></span>
<span id="cb55-56"><a href="#cb55-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-57"><a href="#cb55-57" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb55-58"><a href="#cb55-58" aria-hidden="true" tabindex="-1"></a><span class="co">          Most likely class i.e., Label with the highest score</span></span>
<span id="cb55-59"><a href="#cb55-59" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb55-60"><a href="#cb55-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pass the data through the networks</span></span>
<span id="cb55-61"><a href="#cb55-61" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.forward(x)</span>
<span id="cb55-62"><a href="#cb55-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-63"><a href="#cb55-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Choose the label with the highest score</span></span>
<span id="cb55-64"><a href="#cb55-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># return torch.argmax(output, 1)</span></span>
<span id="cb55-65"><a href="#cb55-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.angle2class(output)</span>
<span id="cb55-66"><a href="#cb55-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-67"><a href="#cb55-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-68"><a href="#cb55-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit(model, X, y, epochs, batch_size, optimizer, criterion, categories, periodicity):</span>
<span id="cb55-69"><a href="#cb55-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List of losses for visualization</span></span>
<span id="cb55-70"><a href="#cb55-70" aria-hidden="true" tabindex="-1"></a>    losses <span class="op">=</span> []</span>
<span id="cb55-71"><a href="#cb55-71" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> []</span>
<span id="cb55-72"><a href="#cb55-72" aria-hidden="true" tabindex="-1"></a>    acc_best <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb55-73"><a href="#cb55-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-74"><a href="#cb55-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb55-75"><a href="#cb55-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pass the data through the network and compute the loss</span></span>
<span id="cb55-76"><a href="#cb55-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We'll use the whole dataset during the training instead of using batches</span></span>
<span id="cb55-77"><a href="#cb55-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># in to order to keep the code simple for now.</span></span>
<span id="cb55-78"><a href="#cb55-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-79"><a href="#cb55-79" aria-hidden="true" tabindex="-1"></a>        batch_loss <span class="op">=</span> []</span>
<span id="cb55-80"><a href="#cb55-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-81"><a href="#cb55-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>((X.shape[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span>) <span class="op">//</span> batch_size <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb55-82"><a href="#cb55-82" aria-hidden="true" tabindex="-1"></a>            start_j <span class="op">=</span> j <span class="op">*</span> batch_size</span>
<span id="cb55-83"><a href="#cb55-83" aria-hidden="true" tabindex="-1"></a>            end_j <span class="op">=</span> start_j <span class="op">+</span> batch_size</span>
<span id="cb55-84"><a href="#cb55-84" aria-hidden="true" tabindex="-1"></a>            xb <span class="op">=</span> X[start_j:end_j]</span>
<span id="cb55-85"><a href="#cb55-85" aria-hidden="true" tabindex="-1"></a>            yb <span class="op">=</span> y[start_j:end_j]</span>
<span id="cb55-86"><a href="#cb55-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-87"><a href="#cb55-87" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> model(xb)</span>
<span id="cb55-88"><a href="#cb55-88" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(y_pred, yb, categories, periodicity)</span>
<span id="cb55-89"><a href="#cb55-89" aria-hidden="true" tabindex="-1"></a>            batch_loss.append((torch.<span class="bu">abs</span>(loss)).detach().numpy())</span>
<span id="cb55-90"><a href="#cb55-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-91"><a href="#cb55-91" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb55-92"><a href="#cb55-92" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb55-93"><a href="#cb55-93" aria-hidden="true" tabindex="-1"></a>            optimizer.step(inputs<span class="op">=</span>xb, layers<span class="op">=</span><span class="bu">list</span>(model.children()))</span>
<span id="cb55-94"><a href="#cb55-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-95"><a href="#cb55-95" aria-hidden="true" tabindex="-1"></a>        losses.append(<span class="bu">sum</span>(batch_loss) <span class="op">/</span> <span class="bu">len</span>(batch_loss))</span>
<span id="cb55-96"><a href="#cb55-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">9</span>:</span>
<span id="cb55-97"><a href="#cb55-97" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Epoch </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> loss is </span><span class="sc">{</span>losses[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb55-98"><a href="#cb55-98" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> model.predict(X)</span>
<span id="cb55-99"><a href="#cb55-99" aria-hidden="true" tabindex="-1"></a>        scores.append(accuracy(y_pred.squeeze(), y))</span>
<span id="cb55-100"><a href="#cb55-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-101"><a href="#cb55-101" aria-hidden="true" tabindex="-1"></a>        Logger.current_logger().report_scalar(</span>
<span id="cb55-102"><a href="#cb55-102" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Loss/Acc"</span>, <span class="st">"Loss"</span>, iteration<span class="op">=</span>i, value<span class="op">=</span>losses[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb55-103"><a href="#cb55-103" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb55-104"><a href="#cb55-104" aria-hidden="true" tabindex="-1"></a>        writer.add_scalar(<span class="st">"Loss"</span>, losses[<span class="op">-</span><span class="dv">1</span>], i)</span>
<span id="cb55-105"><a href="#cb55-105" aria-hidden="true" tabindex="-1"></a>        Logger.current_logger().report_scalar(</span>
<span id="cb55-106"><a href="#cb55-106" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Loss/Acc"</span>, <span class="st">"Acc"</span>, iteration<span class="op">=</span>i, value<span class="op">=</span>scores[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb55-107"><a href="#cb55-107" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb55-108"><a href="#cb55-108" aria-hidden="true" tabindex="-1"></a>        writer.add_scalar(<span class="st">"Accuracy"</span>, scores[<span class="op">-</span><span class="dv">1</span>], i)</span>
<span id="cb55-109"><a href="#cb55-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-110"><a href="#cb55-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key <span class="kw">in</span> model_dict:</span>
<span id="cb55-111"><a href="#cb55-111" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> key_layer <span class="kw">in</span> model_dict[key]:</span>
<span id="cb55-112"><a href="#cb55-112" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> key_layer <span class="kw">in</span> [<span class="st">"weights"</span>, <span class="st">"bias"</span>]:</span>
<span id="cb55-113"><a href="#cb55-113" aria-hidden="true" tabindex="-1"></a>                    log_label <span class="op">=</span> <span class="bu">str</span>(key) <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> <span class="bu">str</span>(key_layer)</span>
<span id="cb55-114"><a href="#cb55-114" aria-hidden="true" tabindex="-1"></a>                    log_label.replace(<span class="st">" "</span>, <span class="st">""</span>)</span>
<span id="cb55-115"><a href="#cb55-115" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb55-116"><a href="#cb55-116" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_real"</span>, model_dict[key][key_layer].real, i</span>
<span id="cb55-117"><a href="#cb55-117" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb55-118"><a href="#cb55-118" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb55-119"><a href="#cb55-119" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_imag"</span>, model_dict[key][key_layer].imag, i</span>
<span id="cb55-120"><a href="#cb55-120" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb55-121"><a href="#cb55-121" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb55-122"><a href="#cb55-122" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_mag"</span>, torch.<span class="bu">abs</span>(model_dict[key][key_layer]), i</span>
<span id="cb55-123"><a href="#cb55-123" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb55-124"><a href="#cb55-124" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb55-125"><a href="#cb55-125" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_angle"</span>, torch.angle(model_dict[key][key_layer]), i</span>
<span id="cb55-126"><a href="#cb55-126" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb55-127"><a href="#cb55-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-128"><a href="#cb55-128" aria-hidden="true" tabindex="-1"></a>        <span class="co"># writer.add_histogram("distribution centers", x + n_iter, i)</span></span>
<span id="cb55-129"><a href="#cb55-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> scores[<span class="op">-</span><span class="dv">1</span>] <span class="op">&gt;</span> acc_best:</span>
<span id="cb55-130"><a href="#cb55-130" aria-hidden="true" tabindex="-1"></a>            acc_best <span class="op">=</span> scores[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb55-131"><a href="#cb55-131" aria-hidden="true" tabindex="-1"></a>            torch.save(model.state_dict(), PATH)</span>
<span id="cb55-132"><a href="#cb55-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-133"><a href="#cb55-133" aria-hidden="true" tabindex="-1"></a>    writer.close()</span>
<span id="cb55-134"><a href="#cb55-134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> losses, scores</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(categories<span class="op">=</span>categories, periodicity<span class="op">=</span>periodicity)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> ComplexMSELoss.<span class="bu">apply</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> ECL(model.parameters(), lr<span class="op">=</span>lr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>task <span class="op">=</span> Task.init(</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    project_name<span class="op">=</span><span class="st">"mlmvn"</span>,</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    task_name<span class="op">=</span><span class="st">"SDD-mlmvn-[48-20-20-11]"</span>,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    tags<span class="op">=</span>[<span class="st">"mlmvn"</span>, <span class="st">"SDD"</span>, <span class="st">"single_run"</span>],</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>writer <span class="op">=</span> SummaryWriter()</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="co">#  capture a dictionary of hyperparameters with config</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>config_dict <span class="op">=</span> {</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"learning_rate"</span>: <span class="dv">1</span>,</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"epochs"</span>: epochs,</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"batch_size"</span>: batch_size,</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"optim"</span>: <span class="st">"ECL"</span>,</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"categories"</span>: categories,</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"periodicity"</span>: periodicity,</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"layer"</span>: <span class="st">"[48-20-20-11]"</span>,</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>task.<span class="ex">connect</span>(config_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ClearML Task: created new task id=63f6d3900d26435baf5c0451ee2550cf
ClearML results page: http://194.94.231.172:8080/projects/cdefd6ee85454e49be01962ad715eca0/experiments/63f6d3900d26435baf5c0451ee2550cf/output/log</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'learning_rate': 1,
 'epochs': 200,
 'batch_size': 538,
 'optim': 'ECL',
 'categories': 2,
 'periodicity': 1,
 'layer': '[48-20-20-11]'}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>x_train, x_valid, y_train, y_valid <span class="op">=</span> get_splitted_data(X, y, neuronCats)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>losses, scores <span class="op">=</span> fit(</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    x_train,</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    y_train,</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    epochs<span class="op">=</span>epochs,</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>batch_size,</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    optimizer<span class="op">=</span>optimizer,</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>    criterion<span class="op">=</span>criterion,</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    categories<span class="op">=</span>categories,</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>    periodicity<span class="op">=</span>periodicity,</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>model.load_state_dict(torch.load(PATH))</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(x_train)</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> accuracy(y_pred.squeeze(), y_train)</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train Acc.: "</span>, acc)</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>Logger.current_logger().report_single_value(</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Train Acc."</span>,</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>    value<span class="op">=</span>acc,</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(x_valid)</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> accuracy(y_pred.squeeze(), y_valid)</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Val Acc.: "</span>, acc)</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>Logger.current_logger().report_single_value(</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Val Acc."</span>,</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>    value<span class="op">=</span>acc,</span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_valid, y_pred.detach().numpy(), zero_division<span class="op">=</span><span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_9096/3249266730.py:46: UserWarning:

To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 9 loss is 0.4918386432669506
Epoch 19 loss is 0.5658443724932558
Epoch 29 loss is 0.547344653493303
Epoch 39 loss is 0.5003598398694803
Epoch 49 loss is 0.45764246002628084
Epoch 59 loss is 0.48134115218311874
Epoch 69 loss is 0.46767609185504994
Epoch 79 loss is 0.47236872848369066
Epoch 89 loss is 0.45542004995148055
Epoch 99 loss is 0.4707600822371793
Epoch 109 loss is 0.4592737186466213
Epoch 119 loss is 0.44952235101712684
Epoch 129 loss is 0.4279650487928361
Epoch 139 loss is 0.4390951851709622
Epoch 149 loss is 0.4078203854663746
Epoch 159 loss is 0.4626180199815107
Epoch 169 loss is 0.4595541584940826
Epoch 179 loss is 0.41118996909517436
Epoch 189 loss is 0.4143808650128177
Epoch 199 loss is 0.42120076453410465
Train Acc.:  0.6030850745630902
Val Acc.:  0.6048876356489788
              precision    recall  f1-score   support

           0       0.90      0.74      0.81      1074
           1       0.71      0.70      0.71      1089
           2       0.79      0.67      0.73      1044
           3       0.85      0.70      0.77      1048
           4       0.78      0.54      0.64      1057
           5       0.72      0.72      0.72      1072
           6       0.71      0.45      0.55      1066
           7       0.98      0.91      0.95      1103
           8       0.98      0.96      0.97      1108
           9       0.85      0.31      0.46      1030
          10       0.70      0.63      0.66      1012

   micro avg       0.82      0.67      0.74     11703
   macro avg       0.82      0.67      0.72     11703
weighted avg       0.82      0.67      0.73     11703
 samples avg       0.64      0.67      0.65     11703
</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>task.mark_completed()</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>task.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mlmvn-48-50-50-11" class="level3">
<h3 class="anchored" data-anchor-id="mlmvn-48-50-50-11">MLMVN [48-50-50-11]</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>PATH <span class="op">=</span> <span class="bu">str</span>(Path.cwd() <span class="op">/</span> <span class="st">"models/autass-mlmvn_48-50-50-11.pt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model(nn.Module):</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, categories, periodicity):</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.categories <span class="op">=</span> categories</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.periodicity <span class="op">=</span> periodicity</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.first_linear <span class="op">=</span> FirstLayer(<span class="dv">48</span>, <span class="dv">50</span>)</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act1 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hidden_layer <span class="op">=</span> HiddenLayer(<span class="dv">50</span>, <span class="dv">50</span>)</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act2 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear_out <span class="op">=</span> OutputLayer(<span class="dv">50</span>, <span class="dv">11</span>)</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act3 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Hooks</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.first_layer_hook_handle <span class="op">=</span> <span class="va">self</span>.first_linear.register_full_backward_hook(</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.first_layer_backward_hook</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hidden_layer_hook_handle <span class="op">=</span> <span class="va">self</span>.hidden_layer.register_full_backward_hook(</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.hidden_layer_backward_hook</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_hook_handle <span class="op">=</span> <span class="va">self</span>.linear_out.register_full_backward_hook(</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.output_layer_backward_hook</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.first_linear(x)</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act1(x)</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.hidden_layer(x)</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act2(x)</span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.linear_out(x)</span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act3(x)</span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> first_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"first_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> hidden_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"hidden_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> output_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"output_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb65-40"><a href="#cb65-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-41"><a href="#cb65-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> angle2class(<span class="va">self</span>, x: torch.tensor) <span class="op">-&gt;</span> torch.tensor:</span>
<span id="cb65-42"><a href="#cb65-42" aria-hidden="true" tabindex="-1"></a>        tmp <span class="op">=</span> x.angle() <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> np.pi</span>
<span id="cb65-43"><a href="#cb65-43" aria-hidden="true" tabindex="-1"></a>        angle <span class="op">=</span> torch.remainder(tmp, <span class="dv">2</span> <span class="op">*</span> np.pi)</span>
<span id="cb65-44"><a href="#cb65-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-45"><a href="#cb65-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This will be the discrete output (the number of sector)</span></span>
<span id="cb65-46"><a href="#cb65-46" aria-hidden="true" tabindex="-1"></a>        o <span class="op">=</span> torch.floor(<span class="va">self</span>.categories <span class="op">*</span> <span class="va">self</span>.periodicity <span class="op">*</span> angle <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> np.pi))</span>
<span id="cb65-47"><a href="#cb65-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.remainder(o, <span class="va">self</span>.categories)</span>
<span id="cb65-48"><a href="#cb65-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-49"><a href="#cb65-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, x):</span>
<span id="cb65-50"><a href="#cb65-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb65-51"><a href="#cb65-51" aria-hidden="true" tabindex="-1"></a><span class="co">        Performs the prediction task of the network</span></span>
<span id="cb65-52"><a href="#cb65-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-53"><a href="#cb65-53" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb65-54"><a href="#cb65-54" aria-hidden="true" tabindex="-1"></a><span class="co">          x: torch.Tensor</span></span>
<span id="cb65-55"><a href="#cb65-55" aria-hidden="true" tabindex="-1"></a><span class="co">            Input tensor of size ([3])</span></span>
<span id="cb65-56"><a href="#cb65-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-57"><a href="#cb65-57" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb65-58"><a href="#cb65-58" aria-hidden="true" tabindex="-1"></a><span class="co">          Most likely class i.e., Label with the highest score</span></span>
<span id="cb65-59"><a href="#cb65-59" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb65-60"><a href="#cb65-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pass the data through the networks</span></span>
<span id="cb65-61"><a href="#cb65-61" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.forward(x)</span>
<span id="cb65-62"><a href="#cb65-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-63"><a href="#cb65-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Choose the label with the highest score</span></span>
<span id="cb65-64"><a href="#cb65-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># return torch.argmax(output, 1)</span></span>
<span id="cb65-65"><a href="#cb65-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.angle2class(output)</span>
<span id="cb65-66"><a href="#cb65-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-67"><a href="#cb65-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-68"><a href="#cb65-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit(model, X, y, epochs, batch_size, optimizer, criterion, categories, periodicity):</span>
<span id="cb65-69"><a href="#cb65-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List of losses for visualization</span></span>
<span id="cb65-70"><a href="#cb65-70" aria-hidden="true" tabindex="-1"></a>    losses <span class="op">=</span> []</span>
<span id="cb65-71"><a href="#cb65-71" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> []</span>
<span id="cb65-72"><a href="#cb65-72" aria-hidden="true" tabindex="-1"></a>    acc_best <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb65-73"><a href="#cb65-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-74"><a href="#cb65-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb65-75"><a href="#cb65-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pass the data through the network and compute the loss</span></span>
<span id="cb65-76"><a href="#cb65-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We'll use the whole dataset during the training instead of using batches</span></span>
<span id="cb65-77"><a href="#cb65-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># in to order to keep the code simple for now.</span></span>
<span id="cb65-78"><a href="#cb65-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-79"><a href="#cb65-79" aria-hidden="true" tabindex="-1"></a>        batch_loss <span class="op">=</span> []</span>
<span id="cb65-80"><a href="#cb65-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-81"><a href="#cb65-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>((X.shape[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span>) <span class="op">//</span> batch_size <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb65-82"><a href="#cb65-82" aria-hidden="true" tabindex="-1"></a>            start_j <span class="op">=</span> j <span class="op">*</span> batch_size</span>
<span id="cb65-83"><a href="#cb65-83" aria-hidden="true" tabindex="-1"></a>            end_j <span class="op">=</span> start_j <span class="op">+</span> batch_size</span>
<span id="cb65-84"><a href="#cb65-84" aria-hidden="true" tabindex="-1"></a>            xb <span class="op">=</span> X[start_j:end_j]</span>
<span id="cb65-85"><a href="#cb65-85" aria-hidden="true" tabindex="-1"></a>            yb <span class="op">=</span> y[start_j:end_j]</span>
<span id="cb65-86"><a href="#cb65-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-87"><a href="#cb65-87" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> model(xb)</span>
<span id="cb65-88"><a href="#cb65-88" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(y_pred, yb, categories, periodicity)</span>
<span id="cb65-89"><a href="#cb65-89" aria-hidden="true" tabindex="-1"></a>            batch_loss.append((torch.<span class="bu">abs</span>(loss)).detach().numpy())</span>
<span id="cb65-90"><a href="#cb65-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-91"><a href="#cb65-91" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb65-92"><a href="#cb65-92" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb65-93"><a href="#cb65-93" aria-hidden="true" tabindex="-1"></a>            optimizer.step(inputs<span class="op">=</span>xb, layers<span class="op">=</span><span class="bu">list</span>(model.children()))</span>
<span id="cb65-94"><a href="#cb65-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-95"><a href="#cb65-95" aria-hidden="true" tabindex="-1"></a>        losses.append(<span class="bu">sum</span>(batch_loss) <span class="op">/</span> <span class="bu">len</span>(batch_loss))</span>
<span id="cb65-96"><a href="#cb65-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">9</span>:</span>
<span id="cb65-97"><a href="#cb65-97" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Epoch </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> loss is </span><span class="sc">{</span>losses[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb65-98"><a href="#cb65-98" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> model.predict(X)</span>
<span id="cb65-99"><a href="#cb65-99" aria-hidden="true" tabindex="-1"></a>        scores.append(accuracy(y_pred.squeeze(), y))</span>
<span id="cb65-100"><a href="#cb65-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-101"><a href="#cb65-101" aria-hidden="true" tabindex="-1"></a>        Logger.current_logger().report_scalar(</span>
<span id="cb65-102"><a href="#cb65-102" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Loss/Acc"</span>, <span class="st">"Loss"</span>, iteration<span class="op">=</span>i, value<span class="op">=</span>losses[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb65-103"><a href="#cb65-103" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb65-104"><a href="#cb65-104" aria-hidden="true" tabindex="-1"></a>        writer.add_scalar(<span class="st">"Loss"</span>, losses[<span class="op">-</span><span class="dv">1</span>], i)</span>
<span id="cb65-105"><a href="#cb65-105" aria-hidden="true" tabindex="-1"></a>        Logger.current_logger().report_scalar(</span>
<span id="cb65-106"><a href="#cb65-106" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Loss/Acc"</span>, <span class="st">"Acc"</span>, iteration<span class="op">=</span>i, value<span class="op">=</span>scores[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb65-107"><a href="#cb65-107" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb65-108"><a href="#cb65-108" aria-hidden="true" tabindex="-1"></a>        writer.add_scalar(<span class="st">"Accuracy"</span>, scores[<span class="op">-</span><span class="dv">1</span>], i)</span>
<span id="cb65-109"><a href="#cb65-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-110"><a href="#cb65-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key <span class="kw">in</span> model_dict:</span>
<span id="cb65-111"><a href="#cb65-111" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> key_layer <span class="kw">in</span> model_dict[key]:</span>
<span id="cb65-112"><a href="#cb65-112" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> key_layer <span class="kw">in</span> [<span class="st">"weights"</span>, <span class="st">"bias"</span>]:</span>
<span id="cb65-113"><a href="#cb65-113" aria-hidden="true" tabindex="-1"></a>                    log_label <span class="op">=</span> <span class="bu">str</span>(key) <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> <span class="bu">str</span>(key_layer)</span>
<span id="cb65-114"><a href="#cb65-114" aria-hidden="true" tabindex="-1"></a>                    log_label.replace(<span class="st">" "</span>, <span class="st">""</span>)</span>
<span id="cb65-115"><a href="#cb65-115" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb65-116"><a href="#cb65-116" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_real"</span>, model_dict[key][key_layer].real, i</span>
<span id="cb65-117"><a href="#cb65-117" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb65-118"><a href="#cb65-118" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb65-119"><a href="#cb65-119" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_imag"</span>, model_dict[key][key_layer].imag, i</span>
<span id="cb65-120"><a href="#cb65-120" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb65-121"><a href="#cb65-121" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb65-122"><a href="#cb65-122" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_mag"</span>, torch.<span class="bu">abs</span>(model_dict[key][key_layer]), i</span>
<span id="cb65-123"><a href="#cb65-123" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb65-124"><a href="#cb65-124" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb65-125"><a href="#cb65-125" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_angle"</span>, torch.angle(model_dict[key][key_layer]), i</span>
<span id="cb65-126"><a href="#cb65-126" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb65-127"><a href="#cb65-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-128"><a href="#cb65-128" aria-hidden="true" tabindex="-1"></a>        <span class="co"># writer.add_histogram("distribution centers", x + n_iter, i)</span></span>
<span id="cb65-129"><a href="#cb65-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> scores[<span class="op">-</span><span class="dv">1</span>] <span class="op">&gt;</span> acc_best:</span>
<span id="cb65-130"><a href="#cb65-130" aria-hidden="true" tabindex="-1"></a>            acc_best <span class="op">=</span> scores[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb65-131"><a href="#cb65-131" aria-hidden="true" tabindex="-1"></a>            torch.save(model.state_dict(), PATH)</span>
<span id="cb65-132"><a href="#cb65-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-133"><a href="#cb65-133" aria-hidden="true" tabindex="-1"></a>    writer.close()</span>
<span id="cb65-134"><a href="#cb65-134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> losses, scores</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(categories<span class="op">=</span>categories, periodicity<span class="op">=</span>periodicity)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> ComplexMSELoss.<span class="bu">apply</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> ECL(model.parameters(), lr<span class="op">=</span>lr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>task <span class="op">=</span> Task.init(</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    project_name<span class="op">=</span><span class="st">"mlmvn"</span>,</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    task_name<span class="op">=</span><span class="st">"SDD-mlmvn-[48-50-50-11]"</span>,</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    tags<span class="op">=</span>[<span class="st">"mlmvn"</span>, <span class="st">"SDD"</span>, <span class="st">"single_run"</span>],</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>writer <span class="op">=</span> SummaryWriter()</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="co">#  capture a dictionary of hyperparameters with config</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>config_dict <span class="op">=</span> {</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"learning_rate"</span>: <span class="dv">1</span>,</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"epochs"</span>: epochs,</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"batch_size"</span>: batch_size,</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"optim"</span>: <span class="st">"ECL"</span>,</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"categories"</span>: categories,</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"periodicity"</span>: periodicity,</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"layer"</span>: <span class="st">"[48-50-50-11]"</span>,</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>task.<span class="ex">connect</span>(config_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ClearML Task: created new task id=3ec0ba0e69fe4e8781f1f56f68bb4df0
ClearML results page: http://194.94.231.172:8080/projects/cdefd6ee85454e49be01962ad715eca0/experiments/3ec0ba0e69fe4e8781f1f56f68bb4df0/output/log</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'learning_rate': 1,
 'epochs': 200,
 'batch_size': 538,
 'optim': 'ECL',
 'categories': 2,
 'periodicity': 1,
 'layer': '[48-50-50-11]'}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>x_train, x_valid, y_train, y_valid <span class="op">=</span> get_splitted_data(X, y, neuronCats)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>losses, scores <span class="op">=</span> fit(</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    x_train,</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    y_train,</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    epochs<span class="op">=</span>epochs,</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>batch_size,</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>    optimizer<span class="op">=</span>optimizer,</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>    criterion<span class="op">=</span>criterion,</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>    categories<span class="op">=</span>categories,</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>    periodicity<span class="op">=</span>periodicity,</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>model.load_state_dict(torch.load(PATH))</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(x_train)</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> accuracy(y_pred.squeeze(), y_train)</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train Acc.: "</span>, acc)</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>Logger.current_logger().report_single_value(</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Train Acc."</span>,</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>    value<span class="op">=</span>acc,</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(x_valid)</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> accuracy(y_pred.squeeze(), y_valid)</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Val Acc.: "</span>, acc)</span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>Logger.current_logger().report_single_value(</span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Val Acc."</span>,</span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>    value<span class="op">=</span>acc,</span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_valid, y_pred.detach().numpy(), zero_division<span class="op">=</span><span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_9096/3249266730.py:46: UserWarning:

To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 9 loss is 0.17595385331554345
Epoch 19 loss is 0.24443298597993288
Epoch 29 loss is 0.34861398016646006
Epoch 39 loss is 0.35088833894092397
Epoch 49 loss is 0.3184690939966281
Epoch 59 loss is 0.29159015152507245
Epoch 69 loss is 0.29664844727356443
Epoch 79 loss is 0.3148698996217653
Epoch 89 loss is 0.34718880768462584
Epoch 99 loss is 0.32786482129724753
Epoch 109 loss is 0.3249049482370644
Epoch 119 loss is 0.31320303291619195
Epoch 129 loss is 0.30243110019968583
Epoch 139 loss is 0.30238450965742614
Epoch 149 loss is 0.29449084419928934
Epoch 159 loss is 0.2935125197293862
Epoch 169 loss is 0.2872804696457938
Epoch 179 loss is 0.29204265563094745
Epoch 189 loss is 0.3058525140885775
Epoch 199 loss is 0.30025929403593016
Train Acc.:  0.827223005597573
Val Acc.:  0.820986071947364
              precision    recall  f1-score   support

           0       0.94      0.93      0.94      1074
           1       0.87      0.82      0.84      1089
           2       0.94      0.90      0.92      1044
           3       0.92      0.88      0.90      1048
           4       0.87      0.78      0.82      1057
           5       0.86      0.87      0.87      1072
           6       0.81      0.72      0.77      1066
           7       0.99      0.96      0.98      1103
           8       1.00      0.99      0.99      1108
           9       0.85      0.80      0.82      1030
          10       0.92      0.87      0.89      1012

   micro avg       0.91      0.87      0.89     11703
   macro avg       0.91      0.87      0.89     11703
weighted avg       0.91      0.87      0.89     11703
 samples avg       0.84      0.87      0.85     11703
</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>task.mark_completed()</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>task.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mlmvn-48-100-100-11" class="level3">
<h3 class="anchored" data-anchor-id="mlmvn-48-100-100-11">MLMVN [48-100-100-11]</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>PATH <span class="op">=</span> <span class="bu">str</span>(Path.cwd() <span class="op">/</span> <span class="st">"models/autass-mlmvn_48-100-100-11.pt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model(nn.Module):</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, categories, periodicity):</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.categories <span class="op">=</span> categories</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.periodicity <span class="op">=</span> periodicity</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.first_linear <span class="op">=</span> FirstLayer(<span class="dv">48</span>, <span class="dv">100</span>)</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act1 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hidden_layer <span class="op">=</span> HiddenLayer(<span class="dv">100</span>, <span class="dv">100</span>)</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act2 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear_out <span class="op">=</span> OutputLayer(<span class="dv">100</span>, <span class="dv">11</span>)</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phase_act3 <span class="op">=</span> cmplx_phase_activation()</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Hooks</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.first_layer_hook_handle <span class="op">=</span> <span class="va">self</span>.first_linear.register_full_backward_hook(</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.first_layer_backward_hook</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hidden_layer_hook_handle <span class="op">=</span> <span class="va">self</span>.hidden_layer.register_full_backward_hook(</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.hidden_layer_backward_hook</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_hook_handle <span class="op">=</span> <span class="va">self</span>.linear_out.register_full_backward_hook(</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.output_layer_backward_hook</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.first_linear(x)</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act1(x)</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.hidden_layer(x)</span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act2(x)</span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.linear_out(x)</span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.phase_act3(x)</span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> first_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"first_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> hidden_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"hidden_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> output_layer_backward_hook(<span class="va">self</span>, module, grad_input, grad_output):</span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a>        fc_hook(<span class="st">"output_layer"</span>, module, grad_input, grad_output)</span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> angle2class(<span class="va">self</span>, x: torch.tensor) <span class="op">-&gt;</span> torch.tensor:</span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a>        tmp <span class="op">=</span> x.angle() <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> np.pi</span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a>        angle <span class="op">=</span> torch.remainder(tmp, <span class="dv">2</span> <span class="op">*</span> np.pi)</span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This will be the discrete output (the number of sector)</span></span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true" tabindex="-1"></a>        o <span class="op">=</span> torch.floor(<span class="va">self</span>.categories <span class="op">*</span> <span class="va">self</span>.periodicity <span class="op">*</span> angle <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> np.pi))</span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.remainder(o, <span class="va">self</span>.categories)</span>
<span id="cb75-48"><a href="#cb75-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-49"><a href="#cb75-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, x):</span>
<span id="cb75-50"><a href="#cb75-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb75-51"><a href="#cb75-51" aria-hidden="true" tabindex="-1"></a><span class="co">        Performs the prediction task of the network</span></span>
<span id="cb75-52"><a href="#cb75-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-53"><a href="#cb75-53" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb75-54"><a href="#cb75-54" aria-hidden="true" tabindex="-1"></a><span class="co">          x: torch.Tensor</span></span>
<span id="cb75-55"><a href="#cb75-55" aria-hidden="true" tabindex="-1"></a><span class="co">            Input tensor of size ([3])</span></span>
<span id="cb75-56"><a href="#cb75-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-57"><a href="#cb75-57" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb75-58"><a href="#cb75-58" aria-hidden="true" tabindex="-1"></a><span class="co">          Most likely class i.e., Label with the highest score</span></span>
<span id="cb75-59"><a href="#cb75-59" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb75-60"><a href="#cb75-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pass the data through the networks</span></span>
<span id="cb75-61"><a href="#cb75-61" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.forward(x)</span>
<span id="cb75-62"><a href="#cb75-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-63"><a href="#cb75-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># # Choose the label with the highest score</span></span>
<span id="cb75-64"><a href="#cb75-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># return torch.argmax(output, 1)</span></span>
<span id="cb75-65"><a href="#cb75-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.angle2class(output)</span>
<span id="cb75-66"><a href="#cb75-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-67"><a href="#cb75-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-68"><a href="#cb75-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit(model, X, y, epochs, batch_size, optimizer, criterion, categories, periodicity):</span>
<span id="cb75-69"><a href="#cb75-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List of losses for visualization</span></span>
<span id="cb75-70"><a href="#cb75-70" aria-hidden="true" tabindex="-1"></a>    losses <span class="op">=</span> []</span>
<span id="cb75-71"><a href="#cb75-71" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> []</span>
<span id="cb75-72"><a href="#cb75-72" aria-hidden="true" tabindex="-1"></a>    acc_best <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb75-73"><a href="#cb75-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-74"><a href="#cb75-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb75-75"><a href="#cb75-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pass the data through the network and compute the loss</span></span>
<span id="cb75-76"><a href="#cb75-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We'll use the whole dataset during the training instead of using batches</span></span>
<span id="cb75-77"><a href="#cb75-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># in to order to keep the code simple for now.</span></span>
<span id="cb75-78"><a href="#cb75-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-79"><a href="#cb75-79" aria-hidden="true" tabindex="-1"></a>        batch_loss <span class="op">=</span> []</span>
<span id="cb75-80"><a href="#cb75-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-81"><a href="#cb75-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>((X.shape[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span>) <span class="op">//</span> batch_size <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb75-82"><a href="#cb75-82" aria-hidden="true" tabindex="-1"></a>            start_j <span class="op">=</span> j <span class="op">*</span> batch_size</span>
<span id="cb75-83"><a href="#cb75-83" aria-hidden="true" tabindex="-1"></a>            end_j <span class="op">=</span> start_j <span class="op">+</span> batch_size</span>
<span id="cb75-84"><a href="#cb75-84" aria-hidden="true" tabindex="-1"></a>            xb <span class="op">=</span> X[start_j:end_j]</span>
<span id="cb75-85"><a href="#cb75-85" aria-hidden="true" tabindex="-1"></a>            yb <span class="op">=</span> y[start_j:end_j]</span>
<span id="cb75-86"><a href="#cb75-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-87"><a href="#cb75-87" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> model(xb)</span>
<span id="cb75-88"><a href="#cb75-88" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(y_pred, yb, categories, periodicity)</span>
<span id="cb75-89"><a href="#cb75-89" aria-hidden="true" tabindex="-1"></a>            batch_loss.append((torch.<span class="bu">abs</span>(loss)).detach().numpy())</span>
<span id="cb75-90"><a href="#cb75-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-91"><a href="#cb75-91" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb75-92"><a href="#cb75-92" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb75-93"><a href="#cb75-93" aria-hidden="true" tabindex="-1"></a>            optimizer.step(inputs<span class="op">=</span>xb, layers<span class="op">=</span><span class="bu">list</span>(model.children()))</span>
<span id="cb75-94"><a href="#cb75-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-95"><a href="#cb75-95" aria-hidden="true" tabindex="-1"></a>        losses.append(<span class="bu">sum</span>(batch_loss) <span class="op">/</span> <span class="bu">len</span>(batch_loss))</span>
<span id="cb75-96"><a href="#cb75-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">9</span>:</span>
<span id="cb75-97"><a href="#cb75-97" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Epoch </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> loss is </span><span class="sc">{</span>losses[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb75-98"><a href="#cb75-98" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> model.predict(X)</span>
<span id="cb75-99"><a href="#cb75-99" aria-hidden="true" tabindex="-1"></a>        scores.append(accuracy(y_pred.squeeze(), y))</span>
<span id="cb75-100"><a href="#cb75-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-101"><a href="#cb75-101" aria-hidden="true" tabindex="-1"></a>        Logger.current_logger().report_scalar(</span>
<span id="cb75-102"><a href="#cb75-102" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Loss/Acc"</span>, <span class="st">"Loss"</span>, iteration<span class="op">=</span>i, value<span class="op">=</span>losses[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb75-103"><a href="#cb75-103" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb75-104"><a href="#cb75-104" aria-hidden="true" tabindex="-1"></a>        writer.add_scalar(<span class="st">"Loss"</span>, losses[<span class="op">-</span><span class="dv">1</span>], i)</span>
<span id="cb75-105"><a href="#cb75-105" aria-hidden="true" tabindex="-1"></a>        Logger.current_logger().report_scalar(</span>
<span id="cb75-106"><a href="#cb75-106" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Loss/Acc"</span>, <span class="st">"Acc"</span>, iteration<span class="op">=</span>i, value<span class="op">=</span>scores[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb75-107"><a href="#cb75-107" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb75-108"><a href="#cb75-108" aria-hidden="true" tabindex="-1"></a>        writer.add_scalar(<span class="st">"Accuracy"</span>, scores[<span class="op">-</span><span class="dv">1</span>], i)</span>
<span id="cb75-109"><a href="#cb75-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-110"><a href="#cb75-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key <span class="kw">in</span> model_dict:</span>
<span id="cb75-111"><a href="#cb75-111" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> key_layer <span class="kw">in</span> model_dict[key]:</span>
<span id="cb75-112"><a href="#cb75-112" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> key_layer <span class="kw">in</span> [<span class="st">"weights"</span>, <span class="st">"bias"</span>]:</span>
<span id="cb75-113"><a href="#cb75-113" aria-hidden="true" tabindex="-1"></a>                    log_label <span class="op">=</span> <span class="bu">str</span>(key) <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> <span class="bu">str</span>(key_layer)</span>
<span id="cb75-114"><a href="#cb75-114" aria-hidden="true" tabindex="-1"></a>                    log_label.replace(<span class="st">" "</span>, <span class="st">""</span>)</span>
<span id="cb75-115"><a href="#cb75-115" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb75-116"><a href="#cb75-116" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_real"</span>, model_dict[key][key_layer].real, i</span>
<span id="cb75-117"><a href="#cb75-117" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb75-118"><a href="#cb75-118" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb75-119"><a href="#cb75-119" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_imag"</span>, model_dict[key][key_layer].imag, i</span>
<span id="cb75-120"><a href="#cb75-120" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb75-121"><a href="#cb75-121" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb75-122"><a href="#cb75-122" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_mag"</span>, torch.<span class="bu">abs</span>(model_dict[key][key_layer]), i</span>
<span id="cb75-123"><a href="#cb75-123" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb75-124"><a href="#cb75-124" aria-hidden="true" tabindex="-1"></a>                    writer.add_histogram(</span>
<span id="cb75-125"><a href="#cb75-125" aria-hidden="true" tabindex="-1"></a>                        log_label <span class="op">+</span> <span class="st">"_angle"</span>, torch.angle(model_dict[key][key_layer]), i</span>
<span id="cb75-126"><a href="#cb75-126" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb75-127"><a href="#cb75-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-128"><a href="#cb75-128" aria-hidden="true" tabindex="-1"></a>        <span class="co"># writer.add_histogram("distribution centers", x + n_iter, i)</span></span>
<span id="cb75-129"><a href="#cb75-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> scores[<span class="op">-</span><span class="dv">1</span>] <span class="op">&gt;</span> acc_best:</span>
<span id="cb75-130"><a href="#cb75-130" aria-hidden="true" tabindex="-1"></a>            acc_best <span class="op">=</span> scores[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb75-131"><a href="#cb75-131" aria-hidden="true" tabindex="-1"></a>            torch.save(model.state_dict(), PATH)</span>
<span id="cb75-132"><a href="#cb75-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-133"><a href="#cb75-133" aria-hidden="true" tabindex="-1"></a>    writer.close()</span>
<span id="cb75-134"><a href="#cb75-134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> losses, scores</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(categories<span class="op">=</span>categories, periodicity<span class="op">=</span>periodicity)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> ComplexMSELoss.<span class="bu">apply</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> ECL(model.parameters(), lr<span class="op">=</span>lr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>task <span class="op">=</span> Task.init(</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    project_name<span class="op">=</span><span class="st">"mlmvn"</span>,</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    task_name<span class="op">=</span><span class="st">"SDD-mlmvn-[48-100-100-11]"</span>,</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    tags<span class="op">=</span>[<span class="st">"mlmvn"</span>, <span class="st">"SDD"</span>, <span class="st">"single_run"</span>],</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>writer <span class="op">=</span> SummaryWriter()</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a><span class="co">#  capture a dictionary of hyperparameters with config</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>config_dict <span class="op">=</span> {</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"learning_rate"</span>: <span class="dv">1</span>,</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"epochs"</span>: epochs,</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"batch_size"</span>: batch_size,</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"optim"</span>: <span class="st">"ECL"</span>,</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"categories"</span>: categories,</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"periodicity"</span>: periodicity,</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"layer"</span>: <span class="st">"[48-100-100-11]"</span>,</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>task.<span class="ex">connect</span>(config_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ClearML Task: created new task id=d2c79e60ea7040fd879fc5e297a36346
ClearML results page: http://194.94.231.172:8080/projects/cdefd6ee85454e49be01962ad715eca0/experiments/d2c79e60ea7040fd879fc5e297a36346/output/log</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'learning_rate': 1,
 'epochs': 200,
 'batch_size': 538,
 'optim': 'ECL',
 'categories': 2,
 'periodicity': 1,
 'layer': '[48-100-100-11]'}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>x_train, x_valid, y_train, y_valid <span class="op">=</span> get_splitted_data(X, y, neuronCats)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>losses, scores <span class="op">=</span> fit(</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    x_train,</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    y_train,</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    epochs<span class="op">=</span>epochs,</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>batch_size,</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>    optimizer<span class="op">=</span>optimizer,</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>    criterion<span class="op">=</span>criterion,</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>    categories<span class="op">=</span>categories,</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>    periodicity<span class="op">=</span>periodicity,</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>model.load_state_dict(torch.load(PATH))</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(x_train)</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> accuracy(y_pred.squeeze(), y_train)</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train Acc.: "</span>, acc)</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>Logger.current_logger().report_single_value(</span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Train Acc."</span>,</span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>    value<span class="op">=</span>acc,</span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(x_valid)</span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> accuracy(y_pred.squeeze(), y_valid)</span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Val Acc.: "</span>, acc)</span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>Logger.current_logger().report_single_value(</span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Val Acc."</span>,</span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>    value<span class="op">=</span>acc,</span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_valid, y_pred.detach().numpy(), zero_division<span class="op">=</span><span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_9096/3249266730.py:46: UserWarning:

To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 9 loss is 0.14845134117007924
Epoch 19 loss is 0.1329600740131187
Epoch 29 loss is 0.1297421221557918
Epoch 39 loss is 0.11658710957349895
Epoch 49 loss is 0.1263711960559784
Epoch 59 loss is 0.15283946197204235
Epoch 69 loss is 0.20268996749466878
Epoch 79 loss is 0.26901874406663706
Epoch 89 loss is 0.3079409409709422
Epoch 99 loss is 0.28158223191896325
Epoch 109 loss is 0.27721301741939225
Epoch 119 loss is 0.23720462062688716
Epoch 129 loss is 0.23388674674232188
Epoch 139 loss is 0.22834769155604162
Epoch 149 loss is 0.22821928822954132
Epoch 159 loss is 0.1975671042738866
Epoch 169 loss is 0.18680390982844616
Epoch 179 loss is 0.18587410530287377
Epoch 189 loss is 0.19314962951484493
Epoch 199 loss is 0.1799970473113
Train Acc.:  0.888774943383327
Val Acc.:  0.8714859437751004
              precision    recall  f1-score   support

           0       0.97      0.94      0.95      1074
           1       0.92      0.88      0.90      1089
           2       0.97      0.91      0.94      1044
           3       0.93      0.92      0.92      1048
           4       0.90      0.88      0.89      1057
           5       0.90      0.89      0.90      1072
           6       0.84      0.79      0.81      1066
           7       1.00      0.98      0.99      1103
           8       1.00      1.00      1.00      1108
           9       0.89      0.88      0.89      1030
          10       0.95      0.91      0.93      1012

   micro avg       0.93      0.91      0.92     11703
   macro avg       0.93      0.91      0.92     11703
weighted avg       0.93      0.91      0.92     11703
 samples avg       0.89      0.91      0.90     11703
</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>task.mark_completed()</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>task.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>